---
title: "Platy analysis"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<!-- Import libraries -->
```{r, echo=FALSE}
library(stringr)
library(reshape2)
library(phyloseq)
```

<!-- Import tax hits and rereplicate -->
```{r, echo=FALSE}
# Import taxonomic assignment data from blast and nw
read.nw <- function(file) {
  nw <- read.table(file, stringsAsFactors=FALSE)
  nw <- nw[order(nw$otu),]
  return(nw)
}

tax97bs <- read.nw("data/otus_97_bysample/nw_tophits.tsv")

# Deal with identical taxonomic assignments (because some reference sequences are not unique...)
# Create names for groups of identical sequences based on members of group...
ident <- readLines("data/ITS2db_trimmed_notuniques_otus.txt")
ident <- gsub("denovo[0-9]*\t", "", ident)
ident <- strsplit(ident, split="\t")
ident2 <- lapply(ident, str_match_all, pattern="[A-I]{1}[0-9]{1,3}.*[_/]")
ident2 <- lapply(ident2, function(g) gsub(pattern="\\..*_$", "", x=unlist(g)))
ident2 <- lapply(ident2, function(g) gsub(pattern="_$", "", g))
ident2 <- lapply(ident2, function(g) unlist(strsplit(g, split="/")))
subtypes <- lapply(ident2, function(x) levels(factor(unlist(x))))
subtypes <- lapply(subtypes, function(s) paste(paste(s, collapse="/"), "_multiple", sep=""))
names(ident) <- subtypes
ident <- melt(do.call(rbind, ident))
ident <- unique(ident[order(ident[,1]), c(3,1)])

# Replace any sequence name in taxonomy assignment that is a member of a group of identical sequences with the name of the group
collapse.idents <- function(df) {
  within(df, {
    for (i in 1:nrow(ident)) {
      hit <- gsub(ident[i,1], ident[i,2], hit)
    }
  })
}

tax97bs <- collapse.idents(tax97bs)

#tax97bs <- get.st(tax97bs)
tax97bs <- with(tax97bs, tax97bs[order(otu, -sim), ])
tax97bs <- tax97bs[!duplicated(tax97bs$otu), ]
rownames(tax97bs) <- tax97bs$otu
```

<!-- Import OTU tables and sample data, and build phyloseq object -->
```{r, echo=FALSE}
# Import OTU tables
otu97bs <- otu_table(read.table("data/otus_97_bysample/97_otus_bysample.tsv", header=T, check.names=F, row.names=1,skip=1, sep="\t", comment.char=""), taxa_are_rows=T)

# Import sample data
sam <- sample_data(read.delim("data/mapping_file.txt", sep="\t", header=T, row.names=1))
# Order levels (Year) to match time order
sam$Year <- factor(sam$Year,levels=c("2014","2015Jan","2015May","2015July","2016March"))

# Build phyloseq object
phy97bs <- phyloseq(otu97bs, tax_table(as.matrix(tax97bs)), sam)
```

<!-- Subset coral data and extract poor matches to blast -->
```{r, echo=FALSE}
# To check the taxa sums and sample sums:
# taxa_sums(phy97bs)
# sample_sums(phy97bs)

# Subset coral samples from entire sequencing run (because it included 2015c water + sediment)
phy97coral <- subset_samples(phy97bs, SampleType=="coral")
# Calculate taxa_sums for coral subset for plotting
phy97coral_ts <- taxa_sums(phy97coral)
# Calculate similarities for plotting
phy97coral_sim <- as.numeric(as.character(data.frame(tax_table(phy97coral))$sim))

# Plot taxa sums and similarity, to be able to see the distribution of similarity across taxonomic abundance.
plot(log10(phy97coral_ts),phy97coral_sim)
# There's a sharp divide between the 95-100% (high-similarity) sequences and the 65-85% (low-similarity) sequences. We blasted the low-similarity sequences (specific queries below, and complete results in poormatch_IDs1.txt), and they primarily blasted to coral or other organisms (not Symbiodinium)

# Create a dataframe from which to extract outliers
phy97coral_outliers <- data.frame(phy97coral_ts,phy97coral_sim)
# Extract outliers to inspect using NCBI Blast
phy97coral_outliers <- subset(phy97coral_outliers, phy97coral_sim<85 & phy97coral_sim>83)

# Filter out taxa which have only 1 representative sequence, and remove them from the phyloseq object
phy97coral.f <- filter_taxa(phy97coral,function(x) sum(x>0) > 1, prune=TRUE)
# Calculate taxa_sums for coral subset for plotting
phy97coral.f_ts <- taxa_sums(phy97coral.f)
# Calculate similarities for plotting
phy97coral.f_sim <- as.numeric(as.character(data.frame(tax_table(phy97coral.f))$sim))

# Plot taxa sums and similarity, to be able to see the distribution of similarity across taxonomic abundance.
plot(log10(phy97coral.f_ts),phy97coral.f_sim)
# There's still a sharp divide between the 95-100% (high-similarity) sequences and the 65-85% (low-similarity) sequences, although the overall number of unique OTUs was lower.

# Create a dataframe from which to extract outliers
phy97coral.f_outliers <- data.frame(phy97coral.f_ts,phy97coral.f_sim)
# Extract outliers to write to poor_matches.txt and then inspect using NCBI Blast
phy97coral.f_outliers <- subset(phy97coral.f_outliers, phy97coral.f_sim<85)

# Write txt file of poor matches to inspect using NCBI Blast
write.table(rownames(phy97coral.f_outliers), file="data/otus_97_bysample/poor_matches.txt", row.names=FALSE, quote=FALSE, col.names=FALSE)
```

<!-- Filter out OTUs that are not Symbiodinium -->
```{r, echo=FALSE}
# If the top hit in NCBI does not contain the string "Symbiodinium", then this sequence is assumed to not be Symbiodinium.
poormatch97bs <- readLines("data/otus_97_bysample/poormatch_IDs.txt")
poormatch97bs <- data.frame(otu=str_extract(poormatch97bs, "denovo[^ ]*"),
                            symbio=str_detect(poormatch97bs, "Symbiodinium"),   # TRUE if Symbiodinium
                            stringsAsFactors = FALSE)
notsymbio97bs <- poormatch97bs[which(poormatch97bs$symbio==F), 1]


# Remove OTUs that are not Symbiodinium
phy97coral.f2 <- prune_taxa(!taxa_names(phy97coral.f) %in% notsymbio97bs, phy97coral.f)
```

<!-- Use merge_taxa to collapse OTUs with equivalent names ("hits") -->
```{r, echo=FALSE}
# Find all entries in the taxa_table that contain DI in "hit"
D1s <- grep("D1", data.frame(tax_table(phy97coral.f2))$hit)
# Merge taxa, collapsing all hits with "D1" into 1 row in the taxa table. Eqtaxa says which taxa to collapse together. Archetype is included or it doesn't work, and refers to which name the new collapsed row will take - however I haven't found out how to modify this without it failing yet.
phy97coral.f2test <- merge_taxa(phy97coral.f2, eqtaxa=D1s, archetype=1)
# Create tt from the taxa table (to use in renaming below)
tt <- data.frame(tax_table(phy97coral.f2test), stringsAsFactors = F)
# Create "isna" which includes the rownames of all taxa where "hit"=NA
isna <- rownames(tt)[is.na(tt$hit)]
# Create info by extracting the row's "hit" string from the original taxa table
info <- data.frame(tax_table(phy97coral.f2), stringsAsFactors = F)[isna, "hit"]
# Rename the NA using the extracted "hit" name from above
tt[isna,"hit"] <- info
# Replace the taxa table in phy97coral.f2test with updated taxa table (tt). Must be converted to matrix first to work.
tax_table(phy97coral.f2test) <- as.matrix(tt)

# See D1 for description/explanation
C3s <- grep("C3_", data.frame(tax_table(phy97coral.f2test))$hit)
phy97coral.f2test <- merge_taxa(phy97coral.f2test, eqtaxa=C3s, archetype=1)
tt <- data.frame(tax_table(phy97coral.f2test), stringsAsFactors = F)
isna <- rownames(tt)[is.na(tt$hit)]
info <- data.frame(tax_table(phy97coral.f2), stringsAsFactors = F)[isna, "hit"]
tt[isna,"hit"] <- info
tax_table(phy97coral.f2test) <- as.matrix(tt)

# See D1 for description/explanation
C15s <- grep("C15_", data.frame(tax_table(phy97coral.f2test))$hit)
phy97coral.f2test <- merge_taxa(phy97coral.f2test, eqtaxa=C15s, archetype=1)
tt <- data.frame(tax_table(phy97coral.f2test), stringsAsFactors = F)
isna <- rownames(tt)[is.na(tt$hit)]
info <- data.frame(tax_table(phy97coral.f2), stringsAsFactors = F)[isna, "hit"]
tt[isna,"hit"] <- info
tax_table(phy97coral.f2test) <- as.matrix(tt)

# See D1 for description/explanation
C31s <- grep("C31_", data.frame(tax_table(phy97coral.f2test))$hit)
phy97coral.f2test <- merge_taxa(phy97coral.f2test, eqtaxa=C31s, archetype=1)
tt <- data.frame(tax_table(phy97coral.f2test), stringsAsFactors = F)
isna <- rownames(tt)[is.na(tt$hit)]
info <- data.frame(tax_table(phy97coral.f2), stringsAsFactors = F)[isna, "hit"]
tt[isna,"hit"] <- info
tax_table(phy97coral.f2test) <- as.matrix(tt)

# See D1 for description/explanation
A121 <- grep("A121_", data.frame(tax_table(phy97coral.f2test))$hit)
phy97coral.f2test <- merge_taxa(phy97coral.f2test, eqtaxa=A121, archetype=1)
tt <- data.frame(tax_table(phy97coral.f2test), stringsAsFactors = F)
isna <- rownames(tt)[is.na(tt$hit)]
info <- data.frame(tax_table(phy97coral.f2), stringsAsFactors = F)[isna, "hit"]
tt[isna,"hit"] <- info
tax_table(phy97coral.f2test) <- as.matrix(tt)

# See D1 for description/explanation
A1 <- grep("A1_", data.frame(tax_table(phy97coral.f2test))$hit)
phy97coral.f2test <- merge_taxa(phy97coral.f2test, eqtaxa=A1, archetype=1)
tt <- data.frame(tax_table(phy97coral.f2test), stringsAsFactors = F)
isna <- rownames(tt)[is.na(tt$hit)]
info <- data.frame(tax_table(phy97coral.f2), stringsAsFactors = F)[isna, "hit"]
tt[isna,"hit"] <- info
tax_table(phy97coral.f2test) <- as.matrix(tt)
```

<!-- Lots of plot exploration -->
```{r, echo=FALSE}
# Subset samples to only look at coral 99
phycoral99 <- subset_samples(phy97coral.f2test,CoralTag=="99")
# Transform sample counts to proportional counts
phycoral99.p <- transform_sample_counts(phycoral99, function(x) x/sum(x))
# Make a bar plot
plot_bar(phycoral99.p,fill="hit")

# Subset samples to only look at coral 29
phycoral29 <- subset_samples(phy97coral.f2test,CoralTag=="29")
# Transform sample counts to proportional counts
phycoral29.p <- transform_sample_counts(phycoral29, function(x) x/sum(x))
# Make a bar plot
plot_bar(phycoral29.p,fill="hit")

# Subset samples to only look at coral 339
phycoral339 <- subset_samples(phy97coral.f2test,CoralTag=="339")
# Transform sample counts to proportional counts
phycoral339.p <- transform_sample_counts(phycoral339, function(x) x/sum(x))
# Make a bar plot
plot_bar(phycoral339.p,fill="hit")

# Subset samples to only look at coral 328
phycoral328 <- subset_samples(phy97coral.f2test,CoralTag=="328")
# Transform sample counts to proportional counts
phycoral328.p <- transform_sample_counts(phycoral328, function(x) x/sum(x))
# Make a bar plot
plot_bar(phycoral328.p,fill="hit")

# Subset samples to only look at coral 289
phycoral289 <- subset_samples(phy97coral.f2test,CoralTag=="289")
# Transform sample counts to proportional counts
phycoral289.p <- transform_sample_counts(phycoral289, function(x) x/sum(x))
# Make a bar plot
plot_bar(phycoral289.p,fill="hit")

# Subset samples to only look at coral 285
phycoral285 <- subset_samples(phy97coral.f2test,CoralTag=="285")
# Transform sample counts to proportional counts
phycoral285.p <- transform_sample_counts(phycoral285, function(x) x/sum(x))
# Make a bar plot
plot_bar(phycoral285.p,fill="hit")

# Subset samples to only look at coral 439
phycoral439 <- subset_samples(phy97coral.f2test,CoralTag=="439")
# Transform sample counts to proportional counts
phycoral439.p <- transform_sample_counts(phycoral439, function(x) x/sum(x))
# Make a bar plot
plot_bar(phycoral439.p,fill="hit")

# Subset samples to only look at coral 810
phycoral810 <- subset_samples(phy97coral.f2test,CoralTag=="810")
# Transform sample counts to proportional counts
phycoral810.p <- transform_sample_counts(phycoral810, function(x) x/sum(x))
# Make a bar plot
plot_bar(phycoral810.p,fill="hit")

# Subset samples to only look at coral 800
phycoral800 <- subset_samples(phy97coral.f2test,CoralTag=="800")
# Transform sample counts to proportional counts
phycoral800.p <- transform_sample_counts(phycoral800, function(x) x/sum(x))
# Make a bar plot
plot_bar(phycoral800.p,fill="hit")

# Subset samples to only look at coral 157
phycoral157 <- subset_samples(phy97coral.f2test,CoralTag=="157")
# Transform sample counts to proportional counts
phycoral157.p <- transform_sample_counts(phycoral157, function(x) x/sum(x))
# Make a bar plot
plot_bar(phycoral157.p,fill="hit")

# Subset samples to only look at coral 161
phycoral161 <- subset_samples(phy97coral.f2test,CoralTag=="161")
# Transform sample counts to proportional counts
phycoral161.p <- transform_sample_counts(phycoral161, function(x) x/sum(x))
# Make a bar plot
plot_bar(phycoral161.p,fill="hit")

# Plot an overall heat map with all samples. This does not tell you much other than that there is variable abundance among taxa
plot_heatmap(phy97coral.f2test,taxa.label="hit")

# Subset coral data set into time points
phycoral2014 <- subset_samples(phy97coral.f2test,Year=="2014")
phycoral2015a <- subset_samples(phy97coral.f2test,Year=="2015Jan")
phycoral2015b <- subset_samples(phy97coral.f2test,Year=="2015May")
phycoral2015c <- subset_samples(phy97coral.f2test,Year=="2015July")
phycoral20156a <- subset_samples(phy97coral.f2test,Year=="2016March")

# Plot heatmaps for each time point
plot_heatmap(phycoral2014,taxa.label="hit")
plot_heatmap(phycoral2015a,taxa.label="hit")
plot_heatmap(phycoral2015b,taxa.label="hit")
plot_heatmap(phycoral2015c,taxa.label="hit")
plot_heatmap(phycoral20156a,taxa.label="hit")

# Subset coral data set into individual species data sets
phy97coral.f2.platy <- subset_samples(phy97coral.f2test,Coral_Species=="Platygyra_sp")
phy97coral.f2.fpenta <- subset_samples(phy97coral.f2test,Coral_Species=="Favites_pentagona")
phy97coral.f2.faviasp <- subset_samples(phy97coral.f2test,Coral_Species=="Favia_sp")
phy97coral.f2.faviam <- subset_samples(phy97coral.f2test,Coral_Species=="Favia_matthai")

# Subset coral data set into individual site data sets
phy97coral.f2.site34 <- subset_samples(phy97coral.f2test,Site=="34")

# Make network plots for species subsets
plot_net(phy97coral.f2.platy,color = "Year")
plot_net(phy97coral.f2.fpenta,color = "Year")
plot_net(phy97coral.f2.faviasp,color = "Year")
plot_net(phy97coral.f2.faviam,color = "Year")

# Make richness plots by species or plots
plot_richness(phy97coral.f2.platy,x="Year",color="as.factor(Site)")
plot_richness(phy97coral.f2.site34,x="Year",color="Coral_Species")
```