---
title: "Bleaching investigation for Platy paper"
author: "Kristina Tietjen"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: true
    toc_depth: 2
    toc_float: yes
---

```{r include=FALSE}
library(magick)
library(here)

```

**Tasks from Slack:  **

i) create a new .Rmd / .html file (in the appropriate Platy Git repo) borrowing code from the tagged coral analysis we've been doing for KI Bleaching MS, and calculate the % of each of the 4 species that were bleached (and ideally also do a table for this in which we know which bleaching category they were i.e. how bleached) in July 2015 and in March/April 2016  

ii) from Kim's Nov. 2015 data, create a spreadsheet (that we can then read into R and do calculations on) with data recorded for the Site, Coral Species, total number of individual colonies of that species that were visible in all photos at that site, total number of individual colonies of that species that were bleached. Then in R, calculate the proportion bleached: overall sites, and by disturbance level.  

iii) we should do the same for the SPQ data for July 2015 and March/April 2016 - will sort out these numbers with Jenn and Jessie as they've been the people primarily working with these data.  (took the cleaned data from the bleaching repo that is from DM cleaning script)

iv) compare the coral net version of proportion bleached from novebmer 2015 against the colony level proportion bleached that I tallied from the photos (from skype 2 Mar 20)  

From i) and ii) I would like to then make a figure that shows the proportion bleached for each of the 4 species at these three time points. -> bar plot  

Statistics: We could then do a series of simply models to quantify the following things:  

a) What proportion of tagged coral colonies was bleached in 2015, and did this differ by species (ie. the 4 species) or disturbance level. Suggested model: mixed effects logistic regression with bleached/not-bleached as response, species and disturbance level as fixed effects, site as random effect.  

b) same question but for Nov. 2015  
 

**3 Mar 20**  

* Make level 1 bleaching healthy (combine 0 and 1)   
* leaving in cut off corals   
* do an iteration where 4s are 0s (just in the write up area)  



**Relevant notes**  

_Binary bleaching_  
* 0 = Not bleaching (as of 3 Mar 20 this includes levels 0, 1, and 4 although sometimes 4 is left as its own category)  
* 1 = Bleaching (as of 3 Mar 20 this includes levels 2 and 3)  


_Bleaching levels_  
* 1 = partial spotty/ patching bleaching (patches smaller than 5cm)  
* 2 = large patches greater than 5cm by not severe  
* 3 = severe or complete bleaching (~80% of the coral is bleached)  
* 4 = recent (texture has not been eroded yet) partial mortality where living tissue is not bleached


**example of level 4**   

```{r example photo, echo=FALSE}

example <- image_read(here::here("data/bleachingdata_2020_analysis", "Level4_example.png"))
example


```


#
```{r load data and packages, message=FALSE, warning=FALSE, include=FALSE}
#<--remove items in the environment-->
#rm(list=ls())

#dev.off()

#<--load required packages-->

require(plyr)
library(ggplot2)
require(tidyr)
library(RColorBrewer)
library(dplyr)
library(reshape2)
library(stringr)
library(lme4)


#<-- read in data -->
taggedcorals <- read.csv(here::here("data/bleachingdata_2020_analysis","KI_taggedcoral_status.csv")) #taken from bleaching paper git repo
metadata <- read.csv(here::here("data/bleachingdata_2020_analysis", "KI_Coralphoto_Metadata_20Jan20_2019DONE.csv")) #taken from bleaching paper git repo
coraldata <- read.csv(here::here("data/bleachingdata_2020_analysis", "KI_sequencing_runs_fromdropbox27Feb20.csv")) #taken from sequencing dropbox 
nov15 <- read.csv(here::here("data/bleachingdata_2020_analysis", "KI_2015d_Merulinidae.csv")) 
sitedata <- read.csv(here::here("data", "KI_Monitoring_Site_Names_for_Publications_Sept2019.csv"))
coralnet <- read.csv(here::here("data/bleachingdata_2020_analysis", "Coral_Data_Master.csv")) #taken from bleaching paper git repo
partialmortality <- read.csv(here::here("data/bleachingdata_2020_analysis", "KI_partialmortality_2016a.csv")) 

```

```{r prep df - tagged corals, message=FALSE, warning=FALSE, include=FALSE}

#<-- look at data and prep -->
###taggedcorals df
head(taggedcorals)

taggedcorals$"X" <- NULL
taggedcorals$"X.1" <- NULL
taggedcorals$"X.2" <- NULL
taggedcorals$"Notes." <- NULL
taggedcorals$"notesstatus" <- NULL

dim(taggedcorals)

names(taggedcorals)
#Note: status2016a = Status as of 2016a (based only on what was known as of 2016a OR subsequently sampled)
#Note: status = IF we then also asume that corals that were found DEAD in 2017 died in the El NiÃ±o 
newcolnames <- c("tag", "site", "disturbcat", "species", "KI14", "KI15apre", "KI15apost", "KI15b", "KI15c", "KI16a", "KI16b", "KI17", "KI18", "KI19", "status2016a", "status")
colnames(taggedcorals) <- newcolnames
names(taggedcorals)

str(taggedcorals)
taggedcorals$site <- as.character(taggedcorals$site)

unique(taggedcorals$site)
unique(taggedcorals$status)
a <- plyr::count(taggedcorals$status)
a

taggedcorals <- taggedcorals[!is.na(taggedcorals$site), ]
taggedcorals <- droplevels(taggedcorals)

c <- plyr::count(taggedcorals$site)
c
mean(c$freq)

head(taggedcorals)

###Change some key variables that are factor to character 
taggedcorals$disturbcat <- as.character(levels(taggedcorals$disturbcat))[taggedcorals$disturbcat]
taggedcorals$species <- as.character(levels(taggedcorals$species))[taggedcorals$species]

## Fix species names
unique(taggedcorals$species)
taggedcorals$species <- ifelse(taggedcorals$species == 'Pocillopora eydouxi', 'Pocillopora grandis', taggedcorals$species) 

## Fix disturbance level for site 25 from HIGH to MED
taggedcorals[taggedcorals$site=="25", ]
### also rename the dataset 
tagged<-taggedcorals
unique(tagged$disturbcat)
tagged$disturbcat <- ifelse(tagged$site=="25","MED",tagged$disturbcat)
tagged[tagged$site=="25", ]

## Add a column for numeric value of disturbance
tagged$disturbnum <- 1
tagged$disturbnum <- ifelse(tagged$disturbcat=="LOW",2,tagged$disturbnum)
tagged$disturbnum <- ifelse(tagged$disturbcat=="MED",3,tagged$disturbnum)
tagged$disturbnum <- ifelse(tagged$disturbcat=="VERYHIGH",4,tagged$disturbnum)

head(tagged)











```

```{r prep df - metadata, message=FALSE, warning=FALSE, include=FALSE}

names(metadata)
meta <- subset(metadata, select = c("field_season", "site", "coral_tag", "binary_bleaching", "bleaching_proportion", "notes_bleaching"))
meta <- meta[(meta$field_season == "KI2015b" | meta$field_season == "KI2015c" | meta$field_season == "KI2016a"),  ]
meta <- droplevels(meta)
dim(meta)
head(meta)
table(meta$field_season)

unique(meta$field_season)
## fixing bleaching proportion column
unique(meta$bleaching_proportion)
meta <- meta[!meta$bleaching_proportion=="No Photo", ]
meta <- droplevels(meta)

#Realized that some of the "NONE"s are not "no bleaching, but rather no photo and the latter was only recorded in the Notes column
meta <- meta[!meta$notes_bleaching=="* NO PHOTO ", ]
meta$bleaching_proportion <- ifelse((meta$bleaching_proportion == "NONE" | meta$bleaching_proportion == "None" | meta$bleaching_proportion == "NONE "),0,meta$bleaching_proportion)
str(meta)

## fixing bleaching proportion column
unique(meta$binary_bleaching)
meta$binary_bleaching <- ifelse((meta$binary_bleaching == "n" | meta$binary_bleaching == "N" | meta$binary_bleaching == "NONE"), 0, 1)
unique(meta$binary_bleaching)
table(meta$bleaching_proportion) 
table(meta$binary_bleaching)

## fix the mistake between binary_bleaching and bleaching_proportion -> used the below code to find the issues in the excel and fixed it there so that is why it is commented out now.
#test <- meta[meta$binary_bleaching==0, ]
#dim(test)
#table(test$bleaching_proportion)  #Ah! Actually 4 colonies that say bleaching proportion =1, but binary_bleaching=0!
#test2 <- test[test$bleaching_proportion==1, ]
#dim(test2)
#test2
#and the other way....
#test <- meta[meta$binary_bleaching==1, ]
#dim(test)
#table(test$bleaching_proportion)  #Ah! And 3 colonies that say bleaching proportion =0, but binary_bleaching=1!
#test3 <- test[test$bleaching_proportion==0, ]
#dim(test3)
#test3

table(meta$field_season, meta$binary_bleaching)
table(meta$field_season, meta$bleaching_proportion)

#We realized that unfortunately there are some duplicates (i.e. the same coral-e)
#test5 <- meta[duplicated(meta[1:3]),]
#test5

head(meta)

#need to reshape - dcast widen the table to have columns for each field seaon so that we can add in NAs for 2016a and 2016bs so that we can then delted them as these are the UNKNOWNS taht were already deleted from the tagged coral dataframe. Then the 506 vs. 434 shoudl be mostly fixed up, except taht we will still have to fix any corals that were retagged so their numbers don't match. 
metawide <- dcast(meta, coral_tag + site ~ field_season, value.var = "bleaching_proportion", fun.aggregate=sum, fill=5)
#Note the 5's are actually NA's
head(metawide)
table(metawide$KI2015b)
table(metawide$KI2015c)
table(metawide$KI2016a)

# #First remove 5s form 2015c cause we dont care about corals that were not sampled before the elnino
# dim(metawide)
# metawide.nona <- metawide[!metawide$KI2015c==5,]
# metawide.nona <- droplevels(metawide.nona)
# dim(metawide.nona) #189 went away good
# table(metawide.nona$KI2015c) #great they are all gone
# 
# #Now remove rows with 5 (aka NAs) from both 2016a and 2016b. 
# 
# metawide.nona <- metawide.nona[!(metawide.nona$KI2016a == 5 & metawide.nona$KI2016b == 5),] #get rid of colonies that were not sampled in either 16a or 16b
# metawide.nona <- droplevels(metawide.nona)
# dim(metawide.nona) #102

# 
# table(metawide.nona$KI2016a)
# table(metawide.nona$KI2016b)
# 
# #take a peak at some of the 5s
# metawide.nona[metawide.nona$KI2016a == 5,] # good non of the colonies that were NA in 2016a were also NA in 2016b
# metawide.nona[metawide.nona$KI2016b == 5,] # good to go

#Change the 5s to NAs
metawide$KI2015b <- ifelse(metawide$KI2015b==5, NA, metawide$KI2015b)
metawide$KI2015c <- ifelse(metawide$KI2015c==5, NA, metawide$KI2015c)
metawide$KI2016a <- ifelse(metawide$KI2016a==5, NA, metawide$KI2016a)
head(metawide)

#look at sites and get rid of ones we dont care about i.e. deep sites
unique(metawide$site)
metawide <- metawide[!(metawide$site == "30_deep" | metawide$site == "34_deep"),]
metawide <- droplevels(metawide)
unique(metawide$site)

#ok now we need to add in species names
#but first have to prepare the document so we can easy compare the tag numbers since I am sure some retag will not be recorded in the metadata
head(coraldata)
#get rid of a bunch of columns so it is easier to work with
corals <- subset(coraldata, select = c("Tag..", "Site.", "Coral.species", "X2015c", "X2016a"))
#change col names
newcolnames2 <- c("tag", "site", "species", "ki15c", "ki16a")
colnames(corals) <- newcolnames2
head(corals)

unique(corals$tag)
unique(metawide$coral_tag)

#need to split the retagges and just work with first tag for now
#first for coral dataframe
str(corals)
corals$tag <- as.character(corals$tag)
corals$tags <- str_split_fixed(corals$tag, "_", 2)
head(corals)
str(corals) #Confusingly it has split the columns, but it still thinks its a single column. 
corals$firsttag <- corals$tags[,1]
corals$secondtag <- corals$tags[,2]
head(corals)

#now for metadata
str(metawide)
metawide$coral_tag <- as.character(metawide$coral_tag)
metawide$tags <- str_split_fixed(metawide$coral_tag, "_", 2)
head(metawide)
str(metawide) #Confusingly it has split the columns, but it still thinks its a single column. 
metawide$firsttag <- metawide$tags[,1]
metawide$secondtag <- metawide$tags[,2]
head(metawide)

comparedataframes <- metawide[(!metawide$firsttag %in% corals$firsttag), ]
dim(comparedataframes) 
comparedataframes

##ok first dont care about the none ones
metawide<-metawide[!metawide$coral_tag == "NONE", ]
dim(metawide)

#1016
#so it really is 1016a in the corals worksheet
corals[corals$firsttag == "1016a",]
#so replace 1016a with 1016
corals$firsttag <- ifelse(corals$firsttag== "1016a", "1016", corals$firsttag)
#check
corals[corals$firsttag == "1016a",]
corals[corals$firsttag == "1016",]

#905
#so it has a ?
corals[corals$firsttag == "905?",]
#so fix that
corals$firsttag <- ifelse(corals$firsttag== "905?", "905", corals$firsttag)
#check
corals[corals$firsttag == "905?",]
corals[corals$firsttag == "905",]

#Unknown_573

metawide[metawide$firsttag == "Unknown",]
metawide[metawide$firsttag == "573",]
metawide[metawide$firsttag == "573b",]
corals[corals$firsttag == "573b",] # ok so this one is the unknown one because it was sampled in 15c
corals[corals$firsttag == "573",]  # ok so the one who is just 573 is 573a and not sampled in 15c and gone 16a and so not in metadata
#so 573b is duplicated in the metadata so need to get rid of the unknown row
dim(metawide)
metawide <- metawide[!metawide$firsttag == "Unknown",]
metawide <- droplevels(metawide)
dim(metawide)
#check
metawide[metawide$firsttag == "573b",]
metawide[metawide$firsttag == "Unknown",]

#get rid of NA
metawide <- metawide[!is.na(metawide$coral_tag), ]

#rerun compare

comparedataframes2 <- metawide[(!metawide$firsttag %in% corals$firsttag), ]
dim(comparedataframes2) #great!

##ok now to transfer the species names
metawide.sp <- metawide
metawide.sp$species <- corals$species[match(metawide.sp$firsttag, corals$firsttag)]
head(metawide.sp)

#check to see how many did not get a species
plyr::count(metawide.sp$species)  # cool they all did

#ok but now to fix some of the naming
str(metawide.sp$species)
metawide.sp$species <- as.character(metawide.sp$species)

#combine the favia, favia sp, and Favia sp
metawide.sp$species <- ifelse((metawide.sp$species == "favia" | metawide.sp$species =="Favia sp" | metawide.sp$species == "favia sp"), "Favia sp", metawide.sp$species)

plyr::count(metawide.sp$species)

#take out species not important for this paper
unique(metawide.sp$species.comb)
metawide.sp <- metawide.sp[!(metawide.sp$species == "Pocillopora eydouxi" | metawide.sp$species == "Montipora foliosa" | metawide.sp$species == "Porites lobata"), ]
metawide.sp <- droplevels(metawide.sp)
plyr::count(metawide.sp$species)

#ok now condense some genuses
##first make a new column for this
metawide.sp$species.comb <- metawide.sp$species

#combine Favites sp and Favites halicora
metawide.sp$species.comb <- ifelse((metawide.sp$species.comb == "Favites sp" | metawide.sp$species.comb =="Favites halicora"), "Favites spp", metawide.sp$species.comb)

#combine Favia sp, Favia speciosa, and Favia matthai
metawide.sp$species.comb <- ifelse((metawide.sp$species.comb == "Favia sp" | metawide.sp$species.comb =="Favia speciosa" | metawide.sp$species.comb == "Favia matthai"), "Favia spp", metawide.sp$species.comb)

#look at it now
plyr::count(metawide.sp$species.comb)

#cool looks good

head(metawide.sp)

#ok it might be ready to go now. 

#ok actually flip it long for when i need it long for figures

metalong.sp <- melt(metawide.sp, na.rm = FALSE, id.vars = c("coral_tag", "site", "tags", "firsttag", "secondtag", "species", "species.comb"))
head(metalong.sp)
colnames(metalong.sp)<-c("coral_tag", "site", "tags", "firsttag", "secondtag", "species", "species.comb", "year", "bleach.prop")
head(metalong.sp)

#take out NA
metalong.sp <- metalong.sp[!is.na(metalong.sp$bleach.prop), ]
head(metalong.sp)

##add in binary bleaching except I am going to create the column myself  0 = no bleaching (level 0 and 1) 1 = bleaching (level 2 and 3)
metalong.sp$bin.bleach <- 0
metalong.sp$bin.bleach <- ifelse((metalong.sp$bleach.prop== "3" | metalong.sp$bleach.prop == "2"), 1, metalong.sp$bin.bleach)

head(metalong.sp)

## add in disturbance
unique(metalong.sp$site)
metalong.sp$disturb <- sitedata$pressure.group[match(metalong.sp$site, sitedata$site)]
unique(metalong.sp$disturb)

head(metalong.sp)
tail(metalong.sp)

#set order of the levels
str(metalong.sp)

#disturbance
levels(metalong.sp$disturb)
metalong.sp[metalong.sp$disturb == "",]
metalong.sp$disturb<-factor(metalong.sp$disturb, levels = c("Very high", "High", "Medium", "Low", "Very low")) 
levels(metalong.sp$disturb)

#species
metalong.sp$species.comb <- as.factor(metalong.sp$species.comb)
levels(metalong.sp$species.comb)
metalong.sp$species.comb<-factor(metalong.sp$species.comb, levels = c("Platygyra sp", "Favia spp", "Favites pentagona", "Favites spp", "Hydnophora microconos")) 
levels(metalong.sp$species.comb)

#bin bleaching 
metalong.sp$bin.bleach <- as.factor(metalong.sp$bin.bleach)
levels(metalong.sp$bin.bleach)
metalong.sp$bin.bleach <- factor(metalong.sp$bin.bleach, levels = c("1", "0"))
levels(metalong.sp$bin.bleach)

#make a df of just 2015c
metalong.sp15c <- metalong.sp[metalong.sp$year == "KI2015c", ]
metalong.sp15c <- droplevels(metalong.sp15c)
unique(metalong.sp15c$year)



```
  
```{r prepping merulinidae from nov 2015, include=FALSE}

head(nov15)
str(nov15)

nov15$species <- as.character(levels(nov15$species))[nov15$species]
nov15$bleaching.proportion <- as.character(nov15$bleaching.proportion)

#check columns because I know I was not careful with capitals etc

unique(nov15$site) #good
#althougth I am going to rename the bay of wrecks one to just BOW so it is shorter
nov15$site <- as.character(levels(nov15$site))[nov15$site]
nov15$site <- ifelse(nov15$site == "BayofWrecks_Loggers", "bow", nov15$site)
unique(nov15$site) #good

unique(nov15$species) #ok of course some to fix which i knew

nov15$species <- ifelse(nov15$species == "hydno", "Hydnophora", nov15$species)
nov15$species <- ifelse(nov15$species == "favia sp.", "Favia sp.", nov15$species)
nov15$species <- ifelse(nov15$species == "favia sp. ", "Favia sp.", nov15$species)
nov15$species <- ifelse(nov15$species == "Favia sp. ", "Favia sp.", nov15$species)
nov15$species <- ifelse(nov15$species == "favid", "Favid", nov15$species)
nov15$species <- ifelse(nov15$species == "f. pentagona", "F. pentagona", nov15$species)
nov15$species <- ifelse(nov15$species == "f pentagona", "F. pentagona", nov15$species)
nov15$species <- ifelse(nov15$species == "F pentagona", "F. pentagona", nov15$species)
nov15$species <- ifelse(nov15$species == "Favities", "Favites sp.", nov15$species)
nov15$species <- ifelse(nov15$species == "favites sp", "Favites sp.", nov15$species)
nov15$species <- ifelse(nov15$species == "Favia halicora", "Favites halicora", nov15$species)
nov15$species <- ifelse(nov15$species == "favia matthai", "Favia matthai", nov15$species)
nov15$species <- ifelse(nov15$species == "Hydno", "Hydnophora", nov15$species)
nov15$species <- ifelse(nov15$species == "platygyra sp.", "Platygyra sp.", nov15$species)

unique(nov15$species) 

unique(nov15$bleaching.proportion) #good to go

unique(nov15$cut.off.y.n) # good to go

head(nov15)

#ok now combine some of the species
nov15$species.comb <- nov15$species

nov15$species.comb <- ifelse((nov15$species == "Favia sp." | nov15$species == "Favia matthai"), "Favia spp", nov15$species.comb)

nov15$species.comb <- ifelse((nov15$species == "Favites halicora" | nov15$species == "Favites sp."), "Favites spp", nov15$species.comb)

unique(nov15$species.comb)

#add disturbance level
nov15$disturb <- "VH"
nov15$disturb <- ifelse(nov15$site == "8", "M", nov15$disturb)
nov15$disturb <- ifelse(nov15$site == "35", "M", nov15$disturb)
nov15$disturb <- ifelse(nov15$site == "bow", "VL", nov15$disturb)

unique(nov15$disturb)

head(nov15)

#add column of binary bleaching
nov15$bin.bleach <- 0
nov15$bin.bleach <- ifelse((nov15$bleaching.proportion == "3" | nov15$bleaching.proportion == "2"), 1, nov15$bin.bleach)
head(nov15)
tail(nov15)

#determine order of levels
str(nov15)
nov15$disturb <- as.factor(nov15$disturb)
levels(nov15$disturb)
nov15$disturb<-factor(nov15$disturb, levels = c("VH", "M", "VL")) 
levels(nov15$disturb)

nov15$species.comb <- as.factor(nov15$species.comb)
levels(nov15$species.comb)
nov15$species.comb<-factor(nov15$species.comb, levels = c("Platygyra sp.", "F. pentagona",  "Favia spp", "Favid", "Favites spp", "Hydnophora")) 
levels(nov15$species.comb)

#make a table

nov.tbl <- plyr::count(nov15, c("site", "species.comb", "bleaching.proportion"))

nov.tbl

colnames(nov.tbl)<-c("site", "species.comb", "bleach.prop", "bleach.prop.freq")
str(nov.tbl)

#take out level 5
nov.tbl <- nov.tbl[!nov.tbl$bleach.prop == "5",]
nov.tbl <- droplevels(nov.tbl)

head(nov.tbl)


## create a version where the 4 is made into a 0
head(nov15)
str(nov15)
nov15$bleach.prop.no4 <- nov15$bleaching.proportion
nov15$bleach.prop.no4 <- ifelse(nov15$bleach.prop.no4 == "4", "0", nov15$bleach.prop.no4)
unique(nov15$bleach.prop.no4)

#take out 5
nov15 <- nov15[!nov15$bleaching.proportion == "5", ]
nov15 <- droplevels(nov15)
unique(nov15$bleach.prop.no4)

#make a table with the new column

nov.tbl.no4 <- plyr::count(nov15, c("site", "species.comb", "bleach.prop.no4"))

nov.tbl.no4

```
  
```{r prepping coral net data, include=FALSE}

head(coralnet)

#take out some columns I dont care about
cn <- subset(coralnet, select = c("Field.Season", "Site", "Quadrat", "adj.total.points.quadrat", "coralnet.tag", "Cover", "Bleached", "Species", "Fish.Level", "adj.total.points.site"))

#subset for 2015c, 2015d, and 2016a
cn <- cn[(cn$Field.Season == "KI2015b" | cn$Field.Season == "KI2015c" | cn$Field.Season == "KI2015d" | cn$Field.Season == "KI2016a"), ]
cn <- droplevels(cn)
unique(cn$Field.Season)

#subset for sites with tagged coral
unique(cn$Site)
sitestokeep <- c("site14", "site15", "site19", "site25",  "site27", "site3",  "site30", "site32",  "site34", "site35",  "site37", "site38", "site40", "site5", "site8" )
cn <- cn[cn$Site%in%sitestokeep, ]
cn <- droplevels(cn)
unique(cn$Site)

#take site out of site column
cn$site <- cn$Site
str(cn$site)
cn$site <- as.character(levels(cn$site))[cn$site]
unique(cn$site)
cn$site <- ifelse(grepl("e3", cn$Site), "3", cn$site)
cn$site <- ifelse(grepl("e5", cn$Site), "5", cn$site)
cn$site <- ifelse(grepl("e8", cn$Site), "8", cn$site)
cn$site <- ifelse(grepl("e14", cn$Site), "14", cn$site)
cn$site <- ifelse(grepl("e15", cn$Site), "15", cn$site)
cn$site <- ifelse(grepl("e19", cn$Site), "19", cn$site)
cn$site <- ifelse(grepl("e25", cn$Site), "25", cn$site)
cn$site <- ifelse(grepl("e27", cn$Site), "27", cn$site)
cn$site <- ifelse(grepl("e30", cn$Site), "30", cn$site)
cn$site <- ifelse(grepl("e32", cn$Site), "32", cn$site)
cn$site <- ifelse(grepl("e34", cn$Site), "34", cn$site)
cn$site <- ifelse(grepl("e35", cn$Site), "35", cn$site)
cn$site <- ifelse(grepl("e37", cn$Site), "37", cn$site)
cn$site <- ifelse(grepl("e38", cn$Site), "38", cn$site)
cn$site <- ifelse(grepl("e40", cn$Site), "40", cn$site)

#subset for just the species I care about
unique(cn$coralnet.tag)
unique(cn$Species)
coralstokeep <- c("Favia.matthai", "Hydnophora.microconos", "Favia.spp", "Platygyra.spp", "Favites.halicora", "Favites.pentagona", "Favites.spp")
cn <- cn[cn$Species%in%coralstokeep, ]
cn <- droplevels(cn)
unique(cn$Species)

#Favia.spp and Favites.spp are not ever recorded so going to take them out
cn[(cn$Species == "Favia.spp" | cn$Species == "Favites.spp"),] # aka the cover is 0 for all of them
cn <- cn[!(cn$Species == "Favia.spp" | cn$Species == "Favites.spp"), ]
cn <- droplevels(cn)

head(cn)

#set order to some of the categories
str(cn)

cn$site <- as.factor(cn$site)
levels(cn$site)
cn$site<-factor(cn$site, levels = c("15", "19", "5", "37", "38", "3", "25", "8", "14", "35", "34", "40", "32", "30", "27"))
levels(cn$site)

levels(cn$Fish.Level)
cn$Fish.Level <- factor(cn$Fish.Level, levels = c("Very.Low", "Low", "Medium",  "High" , "Very.High"))
levels(cn$Fish.Level)

levels(cn$Species)
cn$Species <- factor(cn$Species, levels = c("Platygyra.spp", "Hydnophora.microconos", "Favites.pentagona",  "Favia.matthai", "Favia.spp", "Favites.halicora",  "Favites.spp"))
levels(cn$Species)

head(cn)

###now to create tables and calculate proportions etc

#overall
cn.sum <-aggregate(Cover ~  Species + Field.Season + Bleached, cn, sum)
head(cn.sum)
#calculate the number of points at each site for each species (healthy and bleached) so we can get proportion of bleached vr healthy
cn.sum.species <- aggregate(Cover ~ Species + Field.Season, cn, sum)
head(cn.sum.species)

#now add to the other dataframe 
cn.sum$season.spec <- paste(cn.sum$Field.Season, cn.sum$Species, sep = ".")
cn.sum.species$season.spec <- paste(cn.sum.species$Field.Season, cn.sum.species$Species, sep = ".")
cn.sum$total.season.spec <- cn.sum.species$Cover[match(cn.sum$season.spec, cn.sum.species$season.spec)]
head(cn.sum)

#now calculate proportion
cn.sum$prop <- cn.sum$Cover/cn.sum$total.season.spec
head(cn.sum)

#by site
cn.sum.site<-aggregate(Cover ~  Species + site + Field.Season + Bleached, cn, sum)
head(cn.sum.site)

#calculate the number of points at each site for each species (healthy and bleached) so we can get proportion of bleached vr healthy
cn.sum.species.site <- aggregate(Cover ~ Species + site + Field.Season, cn, sum)
head(cn.sum.species.site)

#now add to the other dataframe 
cn.sum.site$season.site.spec <- paste(cn.sum.site$Field.Season, cn.sum.site$site, cn.sum.site$Species, sep = ".")
cn.sum.species.site$season.site.spec <- paste(cn.sum.species.site$Field.Season, cn.sum.species.site$site, cn.sum.species.site$Species, sep = ".")
cn.sum.site$adj.total.points.site.spec <- cn.sum.species.site$Cover[match(cn.sum.site$season.site.spec, cn.sum.species.site$season.site.spec)]
head(cn.sum.site)

#now calculate proportion
cn.sum.site$prop <- cn.sum.site$Cover/cn.sum.site$adj.total.points.site.spec
head(cn.sum.site)



#by disturbance 
cn.sum.disturb<-aggregate(Cover ~  Species + Fish.Level + Field.Season + Bleached, cn, sum)
head(cn.sum.disturb)

#now to calculate the number of points per disturbance by species
cn.ptsum.disturb.spec<-aggregate(Cover ~ Fish.Level + Field.Season + Species, cn, sum)
head(cn.ptsum.disturb.spec)

#add to other df
cn.ptsum.disturb.spec$season.fish.spec <- paste(cn.ptsum.disturb.spec$Field.Season, cn.ptsum.disturb.spec$Fish.Level, cn.ptsum.disturb.spec$Species, sep = ".")
cn.sum.disturb$season.fish.spec <- paste(cn.sum.disturb$Field.Season, cn.sum.disturb$Fish.Level, cn.sum.disturb$Species, sep = ".")
cn.sum.disturb$adj.total.points.fish.spec <- cn.ptsum.disturb.spec$Cover[match(cn.sum.disturb$season.fish.spec, cn.ptsum.disturb.spec$season.fish.spec)]
head(cn.sum.disturb)

#now calculate proportion
cn.sum.disturb$prop <- cn.sum.disturb$Cover/cn.sum.disturb$adj.total.points.fish.spec
head(cn.sum.disturb)

```
  
```{r prepping partial mortality data, include=FALSE}

head(partialmortality)

#check it to make sure it is nice
unique(partialmortality$field_season)

unique(partialmortality$site)

unique(partialmortality$coral_tag)

unique(partialmortality$species)

unique(partialmortality$tagcompare_year)

unique(partialmortality$partialmortality)

unique(partialmortality$living_tissue_status)

##all looks good so just rename it to have a smaller name

pm <- partialmortality

##check structure
str(pm)

pm$partialmortality <- as.character(pm$partialmortality)
pm$site <- as.character(pm$site)

str(pm)

## make a table 

pm.table <- plyr::count(pm, c("partialmortality", "living_tissue_status") )
pm.table

## make a table with site

pm.site.tbl <- plyr::count(pm, c("site", "partialmortality", "living_tissue_status"))
pm.site.tbl

```
  
  
```{r color set up , include=FALSE}

bleachcols <- c("seagreen4", "seagreen3", "seagreen2", "darkseagreen1")

bleachcols2 <- c("seagreen4", "seagreen3", "seagreen2", "darkseagreen1", "deepskyblue3")

bleachcols3 <- c("indianred2", "deepskyblue2")

pm2 <- c("blue", "seagreen4", "seagreen3", "seagreen2", "darkseagreen1", "deepskyblue3")


```
  
  
# i)  metadata for 2015c and 2016a

## table of bleaching proportion  

level definitions above   

```{r bleaching proportion table, echo=FALSE}

metalong.sp.no15b <- metalong.sp[!metalong.sp$year == "KI2015b", ]
metalong.sp.no15b <- droplevels(metalong.sp.no15b)

tblprob <- plyr::count(metalong.sp.no15b, c("year", "species.comb","bleach.prop"))

tblprob

```

## bar plots

### overall including 2015b - this one is PROPORTION
```{r prep for overall figure metadata, include=FALSE}

metalong.overall.status <- aggregate(coral_tag ~ year + species.comb + bin.bleach, metalong.sp, length)
head(metalong.overall.status)

metalong.overall <- aggregate(coral_tag ~ year + species.comb, metalong.sp, length)
head(metalong.overall)

metalong.overall$year.spec <- paste(metalong.overall$year, metalong.overall$species.comb, sep = ".")
metalong.overall.status$year.spec <- paste(metalong.overall.status$year, metalong.overall.status$species.comb, sep = ".")
metalong.overall.status$overall.spec <- metalong.overall$coral_tag[match(metalong.overall.status$year.spec, metalong.overall$year.spec)]
head(metalong.overall.status)

metalong.overall.status$prop <- metalong.overall.status$coral_tag/metalong.overall.status$overall.spec
head(metalong.overall.status)

#str(metalong.overall.status)
#metalong.overall.status$bin.bleach <- as.character(metalong.overall.status$bin.bleach)

levels(metalong.overall.status$bin.bleach)

```

Healthy = levels 0 and 1  
Bleached = levels 2 and 3  

```{r overall figure metadata, echo=FALSE}

ggplot(metalong.overall.status, aes(x = year, y = prop, fill = bin.bleach)) + geom_bar(stat='identity', position='stack') +
  facet_wrap(~species.comb, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90)) + 
  scale_fill_manual(values = bleachcols3, labels = c("1" = "Bleached", "0" = "Healthy"))

```

### year and level of bleaching

At the colony level (i.e. not proportion).  
Level defnition above  

```{r bleaching proportion figure proportion on x, echo=FALSE}

ggplot(tblprob, aes(x = bleach.prop, y = freq, fill = year)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~species.comb, scales = "free_y") 


```


```{r bleaching proportion figure proportion fill, echo=FALSE}

tblprob$bleach.prop <- as.character(tblprob$bleach.prop)

ggplot(tblprob, aes(x = year, y = freq, fill = bleach.prop)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~species.comb, scales = "free_y") + scale_fill_manual(values = bleachcols)


```


```{r bleaching proportion figure species fill, echo=FALSE}

ggplot(tblprob, aes(x = year, y = freq, fill = species.comb)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~bleach.prop, scales = "free_y") 


```



## statistics

What proportion of tagged coral colonies was bleached in 2015, and did this differ by species (ie. the 4 species) or disturbance level. Suggested model: mixed effects logistic regression with bleached/not-bleached as response, species and disturbance level as fixed effects, site as random effect.    

**not bleached (levels 0 and 1) = 0**     
**bleached (levels 2 and 3) = 1**   

site not included as random effect due to not enough sites within each disturbance level (it would not converge)  
Platygyra and Very High are set as the intercepts  

```{r include=FALSE}
metalong.sp15c$bin.bleach <- as.numeric(levels(metalong.sp15c$bin.bleach))[metalong.sp15c$bin.bleach]

mean(metalong.sp15c$bin.bleach)
var(metalong.sp15c$bin.bleach)

```

```{r stats for i, echo=FALSE}

lr1 <- glm(bin.bleach ~ species.comb + disturb, family =  binomial(link = 'logit'), data = metalong.sp15c)

summary(lr1)

```


# ii) data from photos 2015d
  
## Notes    
I (KT) went through every single photo and tallied each Merulinidae (except for F. speciosa and F. stelligara) that could be seen. The bleaching status of each was recorded using the scale above. I was very careful to not double count any coral that showed up in another photo. There is a category of Favid which are corals that I could tell were a favid but I was unable to tell if it was Favia or Favites.  

I created a column in the datasheet when going through the data for if the coral was cut off or not.  I said y when I estimated I could see less than 60% of the coral. This includes corals cut off on the edge of the photo and also ones that are hiding behind other corals in horizontal shots (compared to bird eye view). Currently all corals I tallied (including ones that had a y for cut off) are included in the figures etc below.  

The BOW site I am not sure where it was as the folder just said BayOfWreck_Loggers. I have just named it BOW for simplicity. Also there were a way fewer photos for the bow site so effort is quite different between bow and the leeward sites.  

I did notice that large proportion of the _Favids_ and _Hydnos_ that were on the healthy end of the spectrum were either JV or shaded by other corals or reef structures.  

## Calculations  

**Platy**   
```{r calculate platy, include=FALSE}

###platy
nov.tbl.platy <- nov.tbl[nov.tbl$species.comb == "Platygyra sp.", ]

nov.tbl.platy

platysum <- sum(nov.tbl.platy$bleach.prop.freq)

nov15.platy <- nov15[nov15$species.comb == "Platygyra sp.",]

platy.disturb <- plyr::count(nov15.platy, c("disturb", "bleaching.proportion"))

platy.disturbsum <-  plyr::count(nov15.platy, c("disturb"))

platy <- plyr::count(nov15.platy$bleaching.proportion)

#no4

nov.tbl.no4.platy <- nov.tbl.no4[nov.tbl.no4$species.comb == "Platygyra sp.", ]

nov.tbl.no4.platy

platysum.no4 <- sum(nov.tbl.no4.platy$freq)

platy.disturb.no4 <- plyr::count(nov15.platy, c("disturb", "bleach.prop.no4"))

platy.no4 <- plyr::count(nov15.platy$bleach.prop.no4)

```
  
In the photos from Kim Cobb from November 2015 there were `r platysum` Platygyra. There were `r platy[1,2]` that were not showing any signs of bleaching (level 0). That is `r (platy[1,2]/platysum)*100`% of the Platys. Only `r platy[2,2]` had level 1 bleaching, `r platy[3,2]` had level 2, and `r platy[4,2]` had level 3. There was `r platy[5,2]` that had the level 4 so when that is added to the level 0 that makes for `r platy.no4[1,2]` or `r (platy.no4[1,2]/platysum.no4)*100`% that showed zero signs of bleaching. Add level 1 to that and it is `r platy.no4[1,2]+platy.no4[2,2]` or `r ((platy.no4[1,2]+platy.no4[2,2])/platysum.no4)*100`%.  

There were `r platy.disturbsum[2,2]` at medium disturbance sites - `r platy.disturb[5,3]` of them were level 0 (`r (platy.disturb[5,3]/platy.disturbsum[2,2])*100`%). Only `r platy.disturb[8,3]` were fully bleached (level 3). There were `r platy.disturbsum[1,2]` at VH sites - `r platy.disturb[1,3]` were not bleached and there were none that were fully bleached. There was only `r platy.disturbsum[3,2]` platy at VL sites but it was not bleached. There were not many photos from BOW though.   

*With level 4 included in level 0:*      
* medium sites     
`r platy.disturb.no4[4,3]` of them were level 0 (`r (platy.disturb.no4[4,3]/platy.disturbsum[2,2])*100`%)  
`r platy.disturb.no4[5,3]` were level 1  
`r platy.disturb.no4[6,3]` were level 2  
`r platy.disturb.no4[7,3]` were level 3  
* vh sites  
`r platy.disturb.no4[1,3]` were level 0  
`r platy.disturb.no4[2,3]` were level 1  
`r platy.disturb.no4[3,3]` were level 2  
there were none that were fully bleached    
* vl site  
 Still just a level 0  
    
**Hydno**    
  
```{r calculate hydno, include=FALSE}

###hydno
nov.tbl.hydno <- nov.tbl[nov.tbl$species.comb == "Hydnophora", ]

nov.tbl.hydno

hydnosum <- sum(nov.tbl.hydno$bleach.prop.freq)

nov15.hydno <- nov15[nov15$species.comb == "Hydnophora",]

hydno.disturb <- plyr::count(nov15.hydno, c("disturb", "bleaching.proportion"))

hydno.distubsum <-  plyr::count(nov15.hydno, c("disturb"))

hydno <- plyr::count(nov15.hydno$bleaching.proportion)

#no level 4
nov.tbl.no4.hydno <- nov.tbl.no4[nov.tbl.no4$species.comb == "Hydnophora", ]

nov.tbl.no4.hydno

hydnosum.no4 <- sum(nov.tbl.no4.hydno$freq)

hydno.disturb.no4 <- plyr::count(nov15.hydno, c("disturb", "bleach.prop.no4"))

hydno.no4 <- plyr::count(nov15.hydno$bleach.prop.no4)

```
   
In the photos from Kim Cobb from November 2015 there were `r hydnosum` Hydnophora. There were `r hydno[1,2]` that were not showing any signs of bleaching. That is `r (hydno[1,2]/hydnosum)*100`% of the hydnos. Only `r hydno[2,2]` had level 1 bleaching, `r hydno[3,2]` had level 2, but `r hydno[4,2]` had level 3. There was `r hydno[5,2]` that had the level 4 so when that is added to the level 0 that makes for `r hydno.no4[1,2]` or `r (hydno.no4[1,2]/hydnosum.no4)*100`% that showed zero signs of bleaching. Add level 1 to that and it is `r hydno.no4[1,2]+hydno.no4[2,2]` or `r ((hydno.no4[1,2]+hydno.no4[2,2])/hydnosum.no4)*100`%.       

There were `r hydno.distubsum[2,2]` at medium disturbance sites - `r hydno.disturb[5,3]` of them were healthy (`r (hydno.disturb[5,3]/hydno.distubsum[2,2])*100`%), `r hydno.disturb[8,3]` were full bleached (level 3) (`r (hydno.disturb[8,3]/hydno.distubsum[2,2])*100`%). There were `r hydno.distubsum[1,2]` at VH sites - `r hydno.disturb[1,3]` were not bleached and there were `r hydno.disturb[3,3]` fully bleached. There was only `r hydno.distubsum[3,2]` at VL sites but they were all fully bleached. 

*With level 4 included in level 0:*      
* medium sites     
`r hydno.disturb.no4[4,3]` of them were level 0 (`r (hydno.disturb.no4[4,3]/hydno.distubsum[2,2])*100`%)  
`r hydno.disturb.no4[5,3]` were level 1  
`r hydno.disturb.no4[6,3]` were level 2  
`r hydno.disturb.no4[7,3]` were level 3  
* vh sites  
`r hydno.disturb.no4[1,3]` were level 0  
`r hydno.disturb.no4[2,3]` were level 1 
None were level 2  
`r hydno.disturb.no4[3,3]` were level 3  
* vl site  
 all were level 3  



**F. pentagona**   

```{r calculate f penta, include=FALSE}

#fpenta
nov.tbl.fpenta <- nov.tbl[nov.tbl$species.comb == "F. pentagona", ]

nov.tbl.fpenta

fpentasum <- sum(nov.tbl.fpenta$bleach.prop.freq)

nov15.fpenta <- nov15[nov15$species.comb == "F. pentagona",]

fpenta.disturb <- plyr::count(nov15.fpenta, c("disturb", "bleaching.proportion"))

fpenta.distubsum <-  plyr::count(nov15.fpenta, c("disturb"))

fpenta <- plyr::count(nov15.fpenta$bleaching.proportion)

#no 4
nov.tbl.no4.fpenta <- nov.tbl.no4[nov.tbl.no4$species.comb == "F. pentagona", ]

nov.tbl.no4.fpenta

fpentasum.no4 <- sum(nov.tbl.no4.fpenta$freq)

fpenta.disturb.no4 <- plyr::count(nov15.fpenta, c("disturb", "bleach.prop.no4"))

fpenta.no4 <- plyr::count(nov15.fpenta$bleach.prop.no4)
  
```  
  

In the photos from Kim Cobb from November 2015 there were `r fpentasum` F. pentagona. There were `r fpenta[1,2]` that were not showing any signs of bleaching. That is `r (fpenta[1,2]/fpentasum)*100`% of the F. pentagona. Only `r fpenta[2,2]` had level 1 bleaching, `r fpenta[3,2]` had level 2, but `r fpenta[4,2]` had level 3. There was `r fpenta[5,2]` that had the level 4 so when that is added to the level 0 that makes for `r fpenta.no4[1,2]` or `r (fpenta.no4[1,2]/fpentasum.no4)*100`% that showed zero signs of bleaching. Add level 1 to that and it is `r fpenta.no4[1,2]+fpenta.no4[2,2]` or `r ((fpenta.no4[1,2]+fpenta.no4[2,2])/fpentasum.no4)*100`%.     

There were `r fpenta.distubsum[2,2]` at medium disturbance sites - `r fpenta.disturb[3,3]` of them were healthy (`r (fpenta.disturb[3,3]/fpenta.distubsum[2,2])*100`%), `r fpenta.disturb[6,3]` were fully bleached (level 3) (`r (fpenta.disturb[6,3]/fpenta.distubsum[2,2])*100`%). There were `r fpenta.distubsum[1,2]` at VH sites - `r fpenta.disturb[1,3]` were not bleached and there were none fully bleached. There was only `r fpenta.distubsum[3,2]` at VL sites and it was a level 2 bleaching. 

*With level 4 included in level 0:*      
* medium sites     
`r fpenta.disturb.no4[3,3]` of them were level 0 (`r (fpenta.disturb.no4[3,3]/fpenta.distubsum[2,2])*100`%)  
`r fpenta.disturb.no4[4,3]` were level 1  
`r fpenta.disturb.no4[5,3]` were level 2  
`r fpenta.disturb.no4[6,3]` were level 3  
* vh sites  
`r fpenta.disturb.no4[1,3]` were level 0  
`r fpenta.disturb.no4[2,3]` were level 1 
None were level 2  
None were level 3  
* vl site  
 all were level 2  


**Favia spp**   

```{r calculate favia, include=FALSE}

#favia
nov.tbl.favia <- nov.tbl[nov.tbl$species.comb == "Favia spp", ]

nov.tbl.favia

faviasum <- sum(nov.tbl.favia$bleach.prop.freq)

nov15.favia <- nov15[nov15$species.comb == "Favia spp",]

favia.disturb <- plyr::count(nov15.favia, c("disturb", "bleaching.proportion"))

favia.distubsum <-  plyr::count(nov15.favia, c("disturb"))

favia <- plyr::count(nov15.favia$bleaching.proportion)

#no 4
nov.tbl.no4.favia <- nov.tbl.no4[nov.tbl.no4$species.comb == "Favia spp", ]

nov.tbl.no4.favia

faviasum.no4 <- sum(nov.tbl.no4.favia$freq)

favia.disturb.no4 <- plyr::count(nov15.favia, c("disturb", "bleach.prop.no4"))

favia.no4 <- plyr::count(nov15.favia$bleach.prop.no4)

```

 
In the photos from Kim Cobb from November 2015 there were `r faviasum` Favia spp. There were `r favia[1,2]` that were not showing any signs of bleaching. That is `r (favia[1,2]/faviasum)*100`% of the Favia. Only `r favia[2,2]` had level 1 bleaching, `r favia[3,2]` had level 2, but `r favia[4,2]` had level 3. There was `r favia[5,2]` that had the level 4 so when that is added to the level 0 that makes for `r favia.no4[1,2]` or `r (favia.no4[1,2]/faviasum.no4)*100`% that showed zero signs of bleaching. Add level 1 to that and it is `r favia.no4[1,2]+favia.no4[2,2]` or `r ((favia.no4[1,2]+favia.no4[2,2])/faviasum.no4)*100`%.     

There were `r favia.distubsum[2,2]` at medium disturbance sites - `r favia.disturb[4,3]` of them were healthy (`r (favia.disturb[4,3]/favia.distubsum[2,2])*100`%), `r favia.disturb[7,3]` were fully bleached (level 3) (`r (favia.disturb[7,3]/favia.distubsum[2,2])*100`%). There were `r favia.distubsum[1,2]` at VH sites - `r favia.disturb[1,3]` were not bleached and there `r favia.disturb[3,3]` fully bleached. There was only `r favia.distubsum[3,2]` at VL sites and it was a level 3 bleaching.   

*With level 4 included in level 0:*      
* medium sites     
`r favia.disturb.no4[4,3]` of them were level 0 (`r (favia.disturb.no4[4,3]/favia.distubsum[2,2])*100`%)  
`r favia.disturb.no4[5,3]` were level 1  
`r favia.disturb.no4[6,3]` were level 2  
`r favia.disturb.no4[7,3]` were level 3  
* vh sites  
`r favia.disturb.no4[1,3]` were level 0    
`r favia.disturb.no4[2,3]` were level 1   
None were level 2    
`r favia.disturb.no4[3,3]` were level 3    
* vl site    
it was level 3  

**Favid**    

```{r calculate favid, include=FALSE}

#favid
nov.tbl.favid <- nov.tbl[nov.tbl$species.comb == "Favid", ]

nov.tbl.favid

favidsum <- sum(nov.tbl.favid$bleach.prop.freq)

nov15.favid <- nov15[nov15$species.comb == "Favid",]

favid.disturb <- plyr::count(nov15.favid, c("disturb", "bleaching.proportion"))

favid.distubsum <-  plyr::count(nov15.favid, c("disturb"))

favid <- plyr::count(nov15.favid$bleaching.proportion)

#no 4
nov.tbl.no4.favid <- nov.tbl.no4[nov.tbl.no4$species.comb == "Favid", ]

nov.tbl.no4.favid

favidsum.no4 <- sum(nov.tbl.no4.favid$freq)

favid.disturb.no4 <- plyr::count(nov15.favid, c("disturb", "bleach.prop.no4"))

favid.no4 <- plyr::count(nov15.favid$bleach.prop.no4)

```


In the photos from Kim Cobb from November 2015 there were `r favidsum` Favid. There were `r favid[1,2]` that were not showing any signs of bleaching. That is `r (favid[1,2]/favidsum)*100`% of the F. pentagona. Only `r favid[2,2]` had level 1 bleaching, `r favid[3,2]` had level 2, but `r favid[4,2]` had level 3. There was `r favid[5,2]` that had the level 4 so when that is added to the level 0 that makes for `r favid.no4[1,2]` or `r (favid.no4[1,2]/favidsum.no4)*100`% that showed zero signs of bleaching. Add level 1 to that and it is `r favid.no4[1,2]+favid.no4[2,2]` or `r ((favid.no4[1,2]+favid.no4[2,2])/favidsum.no4)*100`%.     

There were `r favid.distubsum[2,2]` at medium disturbance sites - `r favid.disturb[5,3]` of them were healthy (`r (favid.disturb[5,3]/favid.distubsum[2,2])*100`%), `r favid.disturb[8,3]` were full bleached (level 3) (`r (favid.disturb[8,3]/favid.distubsum[2,2])*100`%). There were `r favid.distubsum[1,2]` at VH sites - `r favid.disturb[1,3]` were not bleached and there `r favid.disturb[4,3]` fully bleached. There was none at the VL sites.   

*With level 4 included in level 0:*      
* medium sites     
`r favid.disturb.no4[5,3]` of them were level 0 (`r (favid.disturb.no4[4,3]/favid.distubsum[2,2])*100`%)  
`r favid.disturb.no4[6,3]` were level 1  
`r favid.disturb.no4[7,3]` were level 2  
`r favid.disturb.no4[8,3]` were level 3  
* vh sites  
`r favid.disturb.no4[1,3]` were level 0    
`r favid.disturb.no4[2,3]` were level 1   
`r favid.disturb.no4[3,3]` were level 2    
`r favid.disturb.no4[4,3]` were level 3    
* vl site    
None   


## table of bleaching proportion in November 2015

```{r nov 15 table, echo=FALSE, paged.print=TRUE}

nov.tbl

```

## table of bleaching proportion in November 2015 with 4 turned into 0

```{r echo=FALSE, warning=FALSE}

nov.tbl.no4

```


## bar plots   

These are all at the colony level and not proportion.  

### with 4 as an individual level

#### facet wrap by species  

```{r bleaching proportion figure nov 2015 facet by species, echo=FALSE}

ggplot(nov.tbl, aes(x = site, y = bleach.prop.freq, fill = bleach.prop)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~species.comb, scales = "free_y") +
  scale_fill_manual(values = bleachcols2)


```


#### facet wrap by site 

```{r bleaching proportion figure nov 2015 facet by site, echo=FALSE}

ggplot(nov.tbl, aes(x = species.comb, y = bleach.prop.freq, fill = bleach.prop)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~site, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90)) +
  scale_fill_manual(values = bleachcols2)


```


#### facet wrap by bleaching proportion 

```{r bleaching proportion figure nov 2015 facet by bleaching proportion, echo=FALSE}

ggplot(nov.tbl, aes(x = site, y = bleach.prop.freq, fill = species.comb)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~bleach.prop, scales = "free_y") 


```


### with 4 combined with 0

#### facet wrap by species  

```{r bleaching proportion figure nov 2015 facet by species no 4, echo=FALSE}

ggplot(nov.tbl.no4, aes(x = site, y = freq, fill = bleach.prop.no4)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~species.comb, scales = "free_y") +
  scale_fill_manual(values = bleachcols2)


```


#### facet wrap by site 

```{r bleaching proportion figure nov 2015 facet by site no 4, echo=FALSE}

ggplot(nov.tbl.no4, aes(x = species.comb, y = freq, fill = bleach.prop.no4)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~site, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90)) +
  scale_fill_manual(values = bleachcols2)


```


#### facet wrap by bleaching proportion 

```{r bleaching proportion figure nov 2015 facet by bleaching proportion no 4, echo=FALSE}

ggplot(nov.tbl.no4, aes(x = site, y = freq, fill = species.comb)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~bleach.prop.no4, scales = "free_y") 


```


## statistics
 
same question as for the metadata 2015c and 2016a but now with this data  
 
**not bleached (levels 0, 1, 4) = 0**  
**bleached (levels 2, 3) = 1**    

site not included as random effect due to not enough sites within each disturbance level (it would not converge)  

```{r include=FALSE}
mean(nov15$bin.bleach)
var(nov15$bin.bleach)

```

```{r stats for ii, echo=FALSE}

lr2 <- glm(bin.bleach ~ species.comb + disturb, family =  binomial(link = 'logit'), data = nov15)

summary(lr2)

```


# iii) coral net data 2015c, 2015d, 2016a

**important note** 

2015d coral net is only 4 sites - 8, 35, 32, 27....    
This first section includes all sites with tagged corals that were sampled (spq) for that year  
The next section reduces it down to just the 4 sites   


## bar plots  
  
### over time all sites combined   
  
```{r overall figure coralnet, echo=FALSE}

ggplot(cn.sum, aes(x = Field.Season, y = prop, fill = Bleached)) + geom_bar(stat='identity', position='stack') +
  facet_wrap(~Species, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90)) + 
  scale_fill_manual(values = bleachcols3)

```
  
### proportion bleached vrs healthy per field season across sites with tagged corals
  
```{r prop by site 2015c, echo=FALSE, warning=FALSE}

cn.sum.site15c <- cn.sum.site[cn.sum.site$Field.Season == "KI2015c", ]

ggplot(cn.sum.site15c, aes(x = site, y = prop, fill = Bleached)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~Species, scales = "free_y") +
  labs(title = "2015c")+ 
  scale_fill_manual(values = bleachcols3)

```

    
```{r prop by site 2015d, echo=FALSE, warning=FALSE}

cn.sum.site15d <- cn.sum.site[cn.sum.site$Field.Season == "KI2015d", ]

ggplot(cn.sum.site15d, aes(x = site, y = prop, fill = Bleached)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~Species, scales = "free_y") +
  labs(title = "2015d")+ 
  scale_fill_manual(values = bleachcols3)

```
  
  
```{r prop by site 2016a, echo=FALSE, warning=FALSE}

cn.sum.site16a <- cn.sum.site[cn.sum.site$Field.Season == "KI2016a", ]

ggplot(cn.sum.site16a, aes(x = site, y = prop, fill = Bleached)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~Species, scales = "free_y") +
  labs(title = "2016a")+ 
  scale_fill_manual(values = bleachcols3)

```

### across disturbance gradient (again only sites that have tagged corals)

 
```{r prop by disturb 2015c, echo=FALSE, warning=FALSE}

cn.sum.disturb15c <- cn.sum.disturb[cn.sum.disturb$Field.Season == "KI2015c", ]

ggplot(cn.sum.disturb15c, aes(x = Fish.Level, y = prop, fill = Bleached)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~Species) +
  labs(title = "2015c")+ 
  scale_fill_manual(values = bleachcols3)

```

    
```{r prop by disturb 2015d, echo=FALSE, warning=FALSE}

cn.sum.disturb15d <- cn.sum.disturb[cn.sum.disturb$Field.Season == "KI2015d", ]

ggplot(cn.sum.disturb15d, aes(x = Fish.Level, y = prop, fill = Bleached)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~Species) +
  labs(title = "2015d")+ 
  scale_fill_manual(values = bleachcols3)

```
  
  
```{r prop by disturb 2016a, echo=FALSE, warning=FALSE}

cn.sum.disturb16a <- cn.sum.disturb[cn.sum.disturb$Field.Season == "KI2016a", ]

ggplot(cn.sum.disturb16a, aes(x = Fish.Level, y = prop, fill = Bleached)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~Species) +
  labs(title = "2016a")+ 
  scale_fill_manual(values = bleachcols3)

```

## bar plots but with only the 4 sites

```{r include=FALSE}

#by site
head(cn.sum.site)
unique(cn.sum.site$site)

cn.sum.site.c <- cn.sum.site[(cn.sum.site$site == "8" | cn.sum.site$site == "35" | cn.sum.site$site == "27" | cn.sum.site$site == "32"), ]
cn.sum.site.c <- droplevels(cn.sum.site.c)
unique(cn.sum.site.c$site)
head(cn.sum.site.c)


#by disturbance 
cn.c <- cn[(cn$site == "8" | cn$site == "35" | cn$site == "27" | cn$site == "32"), ]
cn.c <- droplevels(cn.c)
unique(cn.c$site)
head(cn.c)

cn.sum.c.disturb<-aggregate(Cover ~  Species + Fish.Level + Field.Season + Bleached, cn.c, sum)
head(cn.sum.c.disturb)

#now to calculate the number of points per disturbance by species
cn.ptsum.disturb.spec.c<-aggregate(Cover ~ Fish.Level + Field.Season + Species, cn.c, sum)
head(cn.ptsum.disturb.spec.c)

#add to other df
cn.ptsum.disturb.spec.c$season.fish.spec <- paste(cn.ptsum.disturb.spec.c$Field.Season, cn.ptsum.disturb.spec.c$Fish.Level, cn.ptsum.disturb.spec.c$Species, sep = ".")
cn.sum.c.disturb$season.fish.spec <- paste(cn.sum.c.disturb$Field.Season, cn.sum.c.disturb$Fish.Level, cn.sum.c.disturb$Species, sep = ".")
cn.sum.c.disturb$adj.total.points.fish.spec <- cn.ptsum.disturb.spec.c$Cover[match(cn.sum.c.disturb$season.fish.spec, cn.ptsum.disturb.spec.c$season.fish.spec)]
head(cn.sum.c.disturb)

#now calculate proportion
cn.sum.c.disturb$prop <- cn.sum.c.disturb$Cover/cn.sum.c.disturb$adj.total.points.fish.spec
head(cn.sum.c.disturb)



#overall
cn.sum.c <-aggregate(Cover ~  Species + Field.Season + Bleached, cn.c, sum)
head(cn.sum.c)
#calculate the number of points at each site for each species (healthy and bleached) so we can get proportion of bleached vr healthy
cn.sum.c.species <- aggregate(Cover ~ Species + Field.Season, cn.c, sum)
head(cn.sum.c.species)

#now add to the other dataframe 
cn.sum.c$season.spec <- paste(cn.sum.c$Field.Season, cn.sum.c$Species, sep = ".")
cn.sum.c.species$season.spec <- paste(cn.sum.c.species$Field.Season, cn.sum.c.species$Species, sep = ".")
cn.sum.c$total.season.spec <- cn.sum.c.species$Cover[match(cn.sum.c$season.spec, cn.sum.c.species$season.spec)]
head(cn.sum.c)

#now calculate proportion
cn.sum.c$prop <- cn.sum.c$Cover/cn.sum.c$total.season.spec
head(cn.sum.c)

```

### over time all sites combined   
  
```{r overall figure coralnet 4 sites, echo=FALSE}

ggplot(cn.sum.c, aes(x = Field.Season, y = prop, fill = Bleached)) + geom_bar(stat='identity', position='stack') +
  facet_wrap(~Species, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90)) + 
  scale_fill_manual(values = bleachcols3)

```

### proportion bleached vrs healthy per field season across the 4 sites
  
```{r prop by site 2015c with only 4 sites, echo=FALSE, warning=FALSE}

cn.sum.sitec15c <- cn.sum.site.c[cn.sum.site.c$Field.Season == "KI2015c", ]

ggplot(cn.sum.sitec15c, aes(x = site, y = prop, fill = Bleached)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~Species, scales = "free_y") +
  labs(title = "2015c")+ 
  scale_fill_manual(values = bleachcols3)

```

    
```{r prop by site 2015d with only 4 sites, echo=FALSE, warning=FALSE}

cn.sum.sitec15d <- cn.sum.site.c[cn.sum.site.c$Field.Season == "KI2015d", ]

ggplot(cn.sum.sitec15d, aes(x = site, y = prop, fill = Bleached)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~Species, scales = "free_y") +
  labs(title = "2015d")+ 
  scale_fill_manual(values = bleachcols3)

```
  
  
```{r prop by site 2016a with only 4 sites, echo=FALSE, warning=FALSE}

cn.sum.sitec16a <- cn.sum.site.c[cn.sum.site.c$Field.Season == "KI2016a", ]

ggplot(cn.sum.sitec16a, aes(x = site, y = prop, fill = Bleached)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~Species, scales = "free_y") +
  labs(title = "2016a")+ 
  scale_fill_manual(values = bleachcols3)

```

### across disturbance gradient (again only the four sites)

 
```{r prop by disturb 2015c with only 4 sites, echo=FALSE, warning=FALSE}

cn.sum.c.disturb15c <- cn.sum.c.disturb[cn.sum.c.disturb$Field.Season == "KI2015c", ]

ggplot(cn.sum.c.disturb15c, aes(x = Fish.Level, y = prop, fill = Bleached)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~Species) +
  labs(title = "2015c")+ 
  scale_fill_manual(values = bleachcols3)

```

    
```{r prop by disturb 2015d with only 4 sites, echo=FALSE, warning=FALSE}

cn.sum.c.disturb15d <- cn.sum.c.disturb[cn.sum.c.disturb$Field.Season == "KI2015d", ]

ggplot(cn.sum.c.disturb15d, aes(x = Fish.Level, y = prop, fill = Bleached)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~Species) +
  labs(title = "2015d")+ 
  scale_fill_manual(values = bleachcols3)

```
  
  
```{r prop by disturb 2016a with only 4 sites, echo=FALSE, warning=FALSE}

cn.sum.c.disturb16a <- cn.sum.c.disturb[cn.sum.c.disturb$Field.Season == "KI2016a", ]

ggplot(cn.sum.c.disturb16a, aes(x = Fish.Level, y = prop, fill = Bleached)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~Species) +
  labs(title = "2016a")+ 
  scale_fill_manual(values = bleachcols3)

```


# iv) Compare coral net 2015d to colony specific data (that KT collected) from photos 2015d

```{r prep data for comparison, include=FALSE}

# data collected from photos by hand
head(nov15)
unique(nov15$site)

# data from coral net
head(cn.sum.site)
unique(cn.sum.site$site)
#select for just 2015d
cn.sum.site.compare <- cn.sum.site[cn.sum.site$Field.Season == "KI2015d", ]

#ok only select for sites that are the same
nov15.compare <- nov15[(nov15$site == "27" | nov15$site == "32" | nov15$site == "35" | nov15$site == "8"), ]
nov15.compare <- droplevels(nov15.compare)
cn.sum.site.compare <- cn.sum.site.compare[(cn.sum.site.compare$site == "27" | cn.sum.site.compare$site == "32" | cn.sum.site.compare$site == "35" | cn.sum.site.compare$site == "8"), ]
cn.sum.site.compare <- droplevels(cn.sum.site.compare)

#get rid of the NA from cn.sum.site.compare
cn.sum.site.compare <- cn.sum.site.compare[!is.na(cn.sum.site.compare$prop),]

#can we combine?
head(nov15.compare)
head(cn.sum.site.compare)

#not yet because nov15.compare is not proportion
#so calculate proportion
#add a column that says bleaching or healthy
str(nov15.compare)
unique(nov15.compare$bin.bleach)
nov15.compare$status <- "Healthy"
nov15.compare$status <- ifelse((nov15.compare$bleaching.proportion == "3" | nov15.compare$bleaching.proportion == "2"| nov15.compare$bleaching.proportion == "1"), "Bleaching", nov15.compare$status)
head(nov15.compare)

#count how many total of each species and status that were each site
nov15.compare.sum.status <- aggregate(cut.off.y.n ~ site + species.comb + status, nov15.compare, length)
head(nov15.compare.sum.status)
colnames(nov15.compare.sum.status)<-c("site", "species.comb" ,"status","total.spec.site.status")

#ok count how many total of each species there were at each site
nov15.compare.sum <- aggregate(cut.off.y.n ~ site + species.comb, nov15.compare, length)
head(nov15.compare.sum)

#combine df
nov15.compare.sum$site.spec <- paste(nov15.compare.sum$site, nov15.compare.sum$species.comb, sep = ".")
nov15.compare.sum.status$site.spec <- paste(nov15.compare.sum.status$site, nov15.compare.sum.status$species.comb, sep = ".")
nov15.compare.sum.status$total.spec.site <- nov15.compare.sum$cut.off.y.n[match(nov15.compare.sum.status$site.spec, nov15.compare.sum$site.spec)]
head(nov15.compare.sum.status)

#calculate proportion bleached
nov15.compare.sum.status$prop <- nov15.compare.sum.status$total.spec.site.status/nov15.compare.sum.status$total.spec.site
head(nov15.compare.sum.status)

#combine
head(nov15.compare.sum.status)
head(cn.sum.site.compare)

#ugg species names are off.... need to fix that
str(nov15.compare.sum.status)
nov15.compare.sum.status$species.comb <- as.character(levels(nov15.compare.sum.status$species.comb))[nov15.compare.sum.status$species.comb]
str(cn.sum.site.compare)
cn.sum.site.compare$Species <- as.character(levels(cn.sum.site.compare$Species))[cn.sum.site.compare$Species]
unique(nov15.compare.sum.status$species.comb)
unique(cn.sum.site.compare$Species)
nov15.compare.sum.status$species.comb <- ifelse(nov15.compare.sum.status$species.comb == "Platygyra sp.", "Platygyra.spp", nov15.compare.sum.status$species.comb)
nov15.compare.sum.status$species.comb <- ifelse(nov15.compare.sum.status$species.comb == "F. pentagona", "Favites.pentagona", nov15.compare.sum.status$species.comb)
nov15.compare.sum.status$species.comb <- ifelse(nov15.compare.sum.status$species.comb == "Hydnophora", "Hydnophora.microconos", nov15.compare.sum.status$species.comb)
cn.sum.site.compare$Species <- ifelse(cn.sum.site.compare$Species == "Favia.matthai", "Favia spp", cn.sum.site.compare$Species)
cn.sum.site.compare$Species <- ifelse(cn.sum.site.compare$Species == "Favites.halicora", "Favites spp", cn.sum.site.compare$Species)
unique(nov15.compare.sum.status$species.comb)
unique(cn.sum.site.compare$Species)


head(cn.sum.site.compare)
head(nov15.compare.sum.status)

#ok now combine
#nov15.compare.sum.status$site.spec.status <- paste(nov15.compare.sum.status$site, nov15.compare.sum.status$species.comb, nov15.compare.sum.status$status, sep = ".")
#cn.sum.site.compare$site.spec.status <- paste(cn.sum.site.compare$site, cn.sum.site.compare$Species, cn.sum.site.compare$Bleached, sep = ".")
cn.sum.site.compare$"Field.Season" <- NULL
cn.sum.site.compare$"season.site.spec" <- NULL
nov15.compare.sum.status$"site.spec" <-NULL
colnames(cn.sum.site.compare)<-c("species", "site" ,"status","total.spec.site.status", "total.spec.site", "prop")
colnames(nov15.compare.sum.status)<-c( "site" , "species", "status","total.spec.site.status", "total.spec.site", "prop")

#create a new column with type
cn.sum.site.compare$type <- "coralnet"
nov15.compare.sum.status$type <- "bycolony"

head(cn.sum.site.compare)
head(nov15.compare.sum.status)

#reorder
cn.sum.site.compare <- cn.sum.site.compare[, c(2, 1, 3, 4, 5, 6, 7)]

head(cn.sum.site.compare)
head(nov15.compare.sum.status)

#ok finally time to combine
compare <- rbind(cn.sum.site.compare, nov15.compare.sum.status)
head(compare)
tail(compare)

```

**there are no Favid from coral net**  

So to really compare those the Favia spp., Favid, and Favites spp would need to be combined.   


```{r compare figure for bleaching, echo=FALSE, warning=FALSE}

compare.bl <- compare[compare$status == "Bleaching",]

ggplot(compare.bl, aes(x = site, y = prop, fill = type)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~species, scales = "free_y") +
  labs(title = "Bleached proportion")

```


```{r compare figure for healthy, echo=FALSE, warning=FALSE}

compare.h <- compare[compare$status == "Healthy",]

ggplot(compare.h, aes(x = site, y = prop, fill = type)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~species, scales = "free_y") +
  labs(title = "Healthy proportion")

```

# v) partial mortality in 2016a of tagged corals  
  
I (KT) went through the photos of the tagged corals in 2016a and compared it to the most recent photo of it from before (i.e. so most of them were compared to 2015c but a few were other field seasons). I recorded the year it was compared to, the level of heat stress induced partial mortality (see scale below), if the remaining tissue was healthy (h; bleaching level 0 and 1 from above) or bleaching (b; bleaching level 2 and 3 from above).   
  
**currently only of F. pentagona.**   

**example photos of a colony bleached in 2015c and then recovered with partial mortality in 2016a**  
*colony 588 from site 15*  

```{r echo=FALSE}

fpenta15c.588 <- image_read(here::here("data/bleachingdata_2020_analysis", "KI2015c_site15_588_smaller.jpeg"))
fpenta15c.588

```

```{r echo=FALSE}

fpenta16a.588 <- image_read(here::here("data/bleachingdata_2020_analysis", "KI2016a_site15_588_smaller.jpeg"))
fpenta16a.588

```
   
**scale**   
0 - no partial mortality    
1 - 0-25% of colony died compared to before El NiÃ±o    
2 - 25-50% "  "     
3 - 50-75% "  "    
4 - 75-100% "  "   
5 - healed its self compared to before   

  
*it was a small dead spot in 2015c but colony 770 at site 32 mostly healed the spot by 2016a hence the creation of a level 5.*   

## table of frequency of each level of partial mortality (with remaining tissue status)  
```{r echo=FALSE}

pm.table

```

  
## plot of frequency of each level of partial mortality (with remaining tissue status) 

```{r echo=FALSE}

ggplot(pm.table, aes(x = partialmortality, y = freq, fill = living_tissue_status)) + geom_bar(stat='identity', position='dodge') 

```

## plot of frequency of each level of partial mortality (with remaining tissue status) by site  

```{r echo=FALSE}

ggplot(pm.site.tbl, aes(x = site, y = freq, fill = partialmortality)) + geom_bar(stat='identity', position='dodge')+
  facet_wrap(~living_tissue_status) +
  scale_fill_manual(values = pm2)

```










