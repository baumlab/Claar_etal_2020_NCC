---
title: "Bleaching investigation for Platy paper"
author: "Kristina Tietjen"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: true
    toc_depth: 2
    toc_float: yes
---

```{r include=FALSE}
library(magick)
library(here)

```

**Tasks from Slack:  **

i) create a new .Rmd / .html file (in the appropriate Platy Git repo) borrowing code from the tagged coral analysis we've been doing for KI Bleaching MS, and calculate the % of each of the 4 species that were bleached (and ideally also do a table for this in which we know which bleaching category they were i.e. how bleached) in July 2015 and in March/April 2016  

ii) from Kim's Nov. 2015 data, create a spreadsheet (that we can then read into R and do calculations on) with data recorded for the Site, Coral Species, total number of individual colonies of that species that were visible in all photos at that site, total number of individual colonies of that species that were bleached. Then in R, calculate the proportion bleached: overall sites, and by disturbance level.  

iii) we should do the same for the SPQ data for July 2015 and March/April 2016 - will sort out these numbers with Jenn and Jessie as they've been the people primarily working with these data.  (took the cleaned data from the bleaching repo that is from DM cleaning script)

iv) compare the coral net version of proportion bleached from novebmer 2015 against the colony level proportion bleached that I tallied from the photos (from skype 2 Mar 20)  

From i) and ii) I would like to then make a figure that shows the proportion bleached for each of the 4 species at these three time points. -> bar plot  

Statistics: We could then do a series of simply models to quantify the following things:  

a) What proportion of tagged coral colonies was bleached in 2015, and did this differ by species (ie. the 4 species) or disturbance level. Suggested model: mixed effects logistic regression with bleached/not-bleached as response, species and disturbance level as fixed effects, site as random effect.  

b) same question but for Nov. 2015  

c) What proportion of tagged coral colonies survived (i.e. March/April 2016 timepoint) and was survival higher at lower levels of disturbance (and did survival differ by species). Same type of model  


** Relevant notes **  

Bleaching levels  
* 1 = partial spotty/ patching bleaching (patches smaller than 5cm)  
* 2 = large patches greater than 5cm by not severe  
* 3 = severe or complete bleaching (~80% of the coral is bleached)  
* 4 = partial mortality but living tissue is not bleached


**example of level 4**   

```{r example photo, echo=FALSE}

example <- image_read(here::here("data/bleachingdata_2020_analysis", "Level4_example.png"))
example


```


#
```{r load data and packages, message=FALSE, warning=FALSE, include=FALSE}
#<--remove items in the environment-->
#rm(list=ls())

#dev.off()

#<--load required packages-->

require(plyr)
library(ggplot2)
require(tidyr)
library(RColorBrewer)
library(dplyr)
library(reshape2)
library(stringr)
library(lme4)


#<-- read in data -->
taggedcorals <- read.csv(here::here("data/bleachingdata_2020_analysis","KI_taggedcoral_status.csv")) #taken from bleaching paper git repo
metadata <- read.csv(here::here("data/bleachingdata_2020_analysis", "KI_Coralphoto_Metadata_20Jan20_2019DONE.csv")) #taken from bleaching paper git repo
coraldata <- read.csv(here::here("data/bleachingdata_2020_analysis", "KI_sequencing_runs_fromdropbox27Feb20.csv")) #taken from sequencing dropbox 
nov15 <- read.csv(here::here("data/bleachingdata_2020_analysis", "KI_2015d_Merulinidae.csv")) 
sitedata <- read.csv(here::here("data", "KI_Monitoring_Site_Names_for_Publications_Sept2019.csv"))
coralnet <- read.csv(here::here("data/bleachingdata_2020_analysis", "Coral_Data_Master.csv")) #taken from bleaching paper git repo

```

```{r prep df - tagged corals, message=FALSE, warning=FALSE, include=FALSE}

#<-- look at data and prep -->
###taggedcorals df
head(taggedcorals)

taggedcorals$"X" <- NULL
taggedcorals$"X.1" <- NULL
taggedcorals$"X.2" <- NULL
taggedcorals$"Notes." <- NULL
taggedcorals$"notesstatus" <- NULL

dim(taggedcorals)

names(taggedcorals)
#Note: status2016a = Status as of 2016a (based only on what was known as of 2016a OR subsequently sampled)
#Note: status = IF we then also asume that corals that were found DEAD in 2017 died in the El NiÃ±o 
newcolnames <- c("tag", "site", "disturbcat", "species", "KI14", "KI15apre", "KI15apost", "KI15b", "KI15c", "KI16a", "KI16b", "KI17", "KI18", "KI19", "status2016a", "status")
colnames(taggedcorals) <- newcolnames
names(taggedcorals)

str(taggedcorals)
taggedcorals$site <- as.character(taggedcorals$site)

unique(taggedcorals$site)
unique(taggedcorals$status)
a <- plyr::count(taggedcorals$status)
a

taggedcorals <- taggedcorals[!is.na(taggedcorals$site), ]
taggedcorals <- droplevels(taggedcorals)

c <- plyr::count(taggedcorals$site)
c
mean(c$freq)

head(taggedcorals)

###Change some key variables that are factor to character 
taggedcorals$disturbcat <- as.character(levels(taggedcorals$disturbcat))[taggedcorals$disturbcat]
taggedcorals$species <- as.character(levels(taggedcorals$species))[taggedcorals$species]

## Fix species names
unique(taggedcorals$species)
taggedcorals$species <- ifelse(taggedcorals$species == 'Pocillopora eydouxi', 'Pocillopora grandis', taggedcorals$species) 

## Fix disturbance level for site 25 from HIGH to MED
taggedcorals[taggedcorals$site=="25", ]
### also rename the dataset 
tagged<-taggedcorals
unique(tagged$disturbcat)
tagged$disturbcat <- ifelse(tagged$site=="25","MED",tagged$disturbcat)
tagged[tagged$site=="25", ]

## Add a column for numeric value of disturbance
tagged$disturbnum <- 1
tagged$disturbnum <- ifelse(tagged$disturbcat=="LOW",2,tagged$disturbnum)
tagged$disturbnum <- ifelse(tagged$disturbcat=="MED",3,tagged$disturbnum)
tagged$disturbnum <- ifelse(tagged$disturbcat=="VERYHIGH",4,tagged$disturbnum)

head(tagged)











```

```{r prep df - metadata, message=FALSE, warning=FALSE, include=FALSE}

names(metadata)
meta <- subset(metadata, select = c("field_season", "site", "coral_tag", "binary_bleaching", "bleaching_proportion", "notes_bleaching"))
meta <- meta[(meta$field_season == "KI2015c" | meta$field_season == "KI2016a"),  ]
meta <- droplevels(meta)
dim(meta)
head(meta)
table(meta$field_season)

unique(meta$field_season)
## fixing bleaching proportion column
unique(meta$bleaching_proportion)
meta <- meta[!meta$bleaching_proportion=="No Photo", ]
meta <- droplevels(meta)

#Realized that some of the "NONE"s are not "no bleaching, but rather no photo and the latter was only recorded in the Notes column
meta <- meta[!meta$notes_bleaching=="* NO PHOTO ", ]
meta$bleaching_proportion <- ifelse((meta$bleaching_proportion == "NONE" | meta$bleaching_proportion == "None" | meta$bleaching_proportion == "NONE "),0,meta$bleaching_proportion)
str(meta)

## fixing bleaching proportion column
unique(meta$binary_bleaching)
meta$binary_bleaching <- ifelse((meta$binary_bleaching == "n" | meta$binary_bleaching == "N" | meta$binary_bleaching == "NONE"), 0, 1)
unique(meta$binary_bleaching)
table(meta$bleaching_proportion) 
table(meta$binary_bleaching)

## fix the mistake between binary_bleaching and bleaching_proportion -> used the below code to find the issues in the excel and fixed it there so that is why it is commented out now.
#test <- meta[meta$binary_bleaching==0, ]
#dim(test)
#table(test$bleaching_proportion)  #Ah! Actually 4 colonies that say bleaching proportion =1, but binary_bleaching=0!
#test2 <- test[test$bleaching_proportion==1, ]
#dim(test2)
#test2
#and the other way....
#test <- meta[meta$binary_bleaching==1, ]
#dim(test)
#table(test$bleaching_proportion)  #Ah! And 3 colonies that say bleaching proportion =0, but binary_bleaching=1!
#test3 <- test[test$bleaching_proportion==0, ]
#dim(test3)
#test3

table(meta$field_season, meta$binary_bleaching)
table(meta$field_season, meta$bleaching_proportion)

#We realized that unfortunately there are some duplicates (i.e. the same coral-e)
#test5 <- meta[duplicated(meta[1:3]),]
#test5

head(meta)

#need to reshape - dcast widen the table to have columns for each field seaon so that we can add in NAs for 2016a and 2016bs so that we can then delted them as these are the UNKNOWNS taht were already deleted from the tagged coral dataframe. Then the 506 vs. 434 shoudl be mostly fixed up, except taht we will still have to fix any corals that were retagged so their numbers don't match. 
metawide <- dcast(meta, coral_tag + site ~ field_season, value.var = "bleaching_proportion", fun.aggregate=sum, fill=5)
#Note the 5's are actually NA's
head(metawide)
table(metawide$KI2015c)
table(metawide$KI2016a)

# #First remove 5s form 2015c cause we dont care about corals that were not sampled before the elnino
# dim(metawide)
# metawide.nona <- metawide[!metawide$KI2015c==5,]
# metawide.nona <- droplevels(metawide.nona)
# dim(metawide.nona) #189 went away good
# table(metawide.nona$KI2015c) #great they are all gone
# 
# #Now remove rows with 5 (aka NAs) from both 2016a and 2016b. 
# 
# metawide.nona <- metawide.nona[!(metawide.nona$KI2016a == 5 & metawide.nona$KI2016b == 5),] #get rid of colonies that were not sampled in either 16a or 16b
# metawide.nona <- droplevels(metawide.nona)
# dim(metawide.nona) #102

# 
# table(metawide.nona$KI2016a)
# table(metawide.nona$KI2016b)
# 
# #take a peak at some of the 5s
# metawide.nona[metawide.nona$KI2016a == 5,] # good non of the colonies that were NA in 2016a were also NA in 2016b
# metawide.nona[metawide.nona$KI2016b == 5,] # good to go

#Change the 5s to NAs

metawide$KI2015c <- ifelse(metawide$KI2015c==5, NA, metawide$KI2015c)
metawide$KI2016a <- ifelse(metawide$KI2016a==5, NA, metawide$KI2016a)
head(metawide)

#look at sites and get rid of ones we dont care about i.e. deep sites
unique(metawide$site)
metawide <- metawide[!(metawide$site == "30_deep" | metawide$site == "34_deep"),]
metawide <- droplevels(metawide)
unique(metawide$site)

#ok now we need to add in species names
#but first have to prepare the document so we can easy compare the tag numbers since I am sure some retag will not be recorded in the metadata
head(coraldata)
#get rid of a bunch of columns so it is easier to work with
corals <- subset(coraldata, select = c("Tag..", "Site.", "Coral.species", "X2015c", "X2016a"))
#change col names
newcolnames2 <- c("tag", "site", "species", "ki15c", "ki16a")
colnames(corals) <- newcolnames2
head(corals)

unique(corals$tag)
unique(metawide$coral_tag)

#need to split the retagges and just work with first tag for now
#first for coral dataframe
str(corals)
corals$tag <- as.character(corals$tag)
corals$tags <- str_split_fixed(corals$tag, "_", 2)
head(corals)
str(corals) #Confusingly it has split the columns, but it still thinks its a single column. 
corals$firsttag <- corals$tags[,1]
corals$secondtag <- corals$tags[,2]
head(corals)

#now for metadata
str(metawide)
metawide$coral_tag <- as.character(metawide$coral_tag)
metawide$tags <- str_split_fixed(metawide$coral_tag, "_", 2)
head(metawide)
str(metawide) #Confusingly it has split the columns, but it still thinks its a single column. 
metawide$firsttag <- metawide$tags[,1]
metawide$secondtag <- metawide$tags[,2]
head(metawide)

comparedataframes <- metawide[(!metawide$firsttag %in% corals$firsttag), ]
dim(comparedataframes) 
comparedataframes

##ok first dont care about the none ones
metawide<-metawide[!metawide$coral_tag == "NONE", ]
dim(metawide)

#1016
#so it really is 1016a in the corals worksheet
corals[corals$firsttag == "1016a",]
#so replace 1016a with 1016
corals$firsttag <- ifelse(corals$firsttag== "1016a", "1016", corals$firsttag)
#check
corals[corals$firsttag == "1016a",]
corals[corals$firsttag == "1016",]

#905
#so it has a ?
corals[corals$firsttag == "905?",]
#so fix that
corals$firsttag <- ifelse(corals$firsttag== "905?", "905", corals$firsttag)
#check
corals[corals$firsttag == "905?",]
corals[corals$firsttag == "905",]

#Unknown_573

metawide[metawide$firsttag == "Unknown",]
metawide[metawide$firsttag == "573",]
metawide[metawide$firsttag == "573b",]
corals[corals$firsttag == "573b",] # ok so this one is the unknown one because it was sampled in 15c
corals[corals$firsttag == "573",]  # ok so the one who is just 573 is 573a and not sampled in 15c and gone 16a and so not in metadata
#so 573b is duplicated in the metadata so need to get rid of the unknown row
dim(metawide)
metawide <- metawide[!metawide$firsttag == "Unknown",]
metawide <- droplevels(metawide)
dim(metawide)
#check
metawide[metawide$firsttag == "573b",]
metawide[metawide$firsttag == "Unknown",]

#rerun compare

comparedataframes2 <- metawide[(!metawide$firsttag %in% corals$firsttag), ]
dim(comparedataframes2) #great!

##ok now to transfer the species names
metawide.sp <- metawide
metawide.sp$species <- corals$species[match(metawide.sp$firsttag, corals$firsttag)]
head(metawide.sp)

#check to see how many did not get a species
plyr::count(metawide.sp$species)  # cool they all did

#ok but now to fix some of the naming
str(metawide.sp$species)
metawide.sp$species <- as.character(metawide.sp$species)

#combine the favia, favia sp, and Favia sp
metawide.sp$species <- ifelse((metawide.sp$species == "favia" | metawide.sp$species =="Favia sp" | metawide.sp$species == "favia sp"), "Favia sp", metawide.sp$species)

plyr::count(metawide.sp$species)

#take out species not important for this paper
unique(metawide.sp$species.comb)
metawide.sp <- metawide.sp[!(metawide.sp$species == "Pocillopora eydouxi" | metawide.sp$species == "Montipora foliosa" | metawide.sp$species == "Porites lobata"), ]
metawide.sp <- droplevels(metawide.sp)
plyr::count(metawide.sp$species)

#ok now condense some genuses
##first make a new column for this
metawide.sp$species.comb <- metawide.sp$species

#combine Favites sp and Favites halicora
metawide.sp$species.comb <- ifelse((metawide.sp$species.comb == "Favites sp" | metawide.sp$species.comb =="Favites halicora"), "Favites spp", metawide.sp$species.comb)

#combine Favia sp, Favia speciosa, and Favia matthai
metawide.sp$species.comb <- ifelse((metawide.sp$species.comb == "Favia sp" | metawide.sp$species.comb =="Favia speciosa" | metawide.sp$species.comb == "Favia matthai"), "Favia spp", metawide.sp$species.comb)

#look at it now
plyr::count(metawide.sp$species.comb)

#cool looks good

head(metawide.sp)

#ok it might be ready to go now. 

#ok actually flip it long for when i need it long for figures

metalong.sp <- melt(metawide.sp, na.rm = FALSE, id.vars = c("coral_tag", "site", "tags", "firsttag", "secondtag", "species", "species.comb"))
head(metalong.sp)
colnames(metalong.sp)<-c("coral_tag", "site", "tags", "firsttag", "secondtag", "species", "species.comb", "year", "bleach.prop")
head(metalong.sp)

#take out NA
metalong.sp <- metalong.sp[!is.na(metalong.sp$bleach.prop), ]
head(metalong.sp)

##add in binary bleaching except I am going to create the column myself  0 = no bleaching 1 = bleaching
metalong.sp$bin.bleach <- 0
metalong.sp$bin.bleach <- ifelse((metalong.sp$bleach.prop== "3" | metalong.sp$bleach.prop == "2" | metalong.sp$bleach.prop == "1"), 1, metalong.sp$bin.bleach)

head(metalong.sp)

## add in disturbance
unique(metalong.sp$site)
metalong.sp$disturb <- sitedata$pressure.group[match(metalong.sp$site, sitedata$site)]
unique(metalong.sp$disturb)

head(metalong.sp)
tail(metalong.sp)

#set order of the levels
str(metalong.sp)

#disturbance
levels(metalong.sp$disturb)
metalong.sp[metalong.sp$disturb == "",]
metalong.sp$disturb<-factor(metalong.sp$disturb, levels = c("Very high", "High", "Medium", "Low", "Very low")) 
levels(metalong.sp$disturb)

#species
metalong.sp$species.comb <- as.factor(metalong.sp$species.comb)
levels(metalong.sp$species.comb)
metalong.sp$species.comb<-factor(metalong.sp$species.comb, levels = c("Platygyra sp", "Favia spp", "Favites pentagona", "Favites spp", "Hydnophora microconos")) 
levels(metalong.sp$species.comb)

#make a df of just 2015c
metalong.sp15c <- metalong.sp[metalong.sp$year == "KI2015c", ]
metalong.sp15c <- droplevels(metalong.sp15c)
unique(metalong.sp15c$year)

```
  
```{r prepping merulinidae from nov 2015, include=FALSE}

head(nov15)
str(nov15)

nov15$species <- as.character(levels(nov15$species))[nov15$species]
nov15$bleaching.proportion <- as.character(nov15$bleaching.proportion)

#check columns because I know I was not careful with capitals etc

unique(nov15$site) #good

unique(nov15$species) #ok of course some to fix which i knew


nov15$species <- ifelse(nov15$species == "hydno", "Hydnophora", nov15$species)
nov15$species <- ifelse(nov15$species == "favia sp.", "Favia sp.", nov15$species)
nov15$species <- ifelse(nov15$species == "favia sp. ", "Favia sp.", nov15$species)
nov15$species <- ifelse(nov15$species == "Favia sp. ", "Favia sp.", nov15$species)
nov15$species <- ifelse(nov15$species == "favid", "Favid", nov15$species)
nov15$species <- ifelse(nov15$species == "f. pentagona", "F. pentagona", nov15$species)
nov15$species <- ifelse(nov15$species == "f pentagona", "F. pentagona", nov15$species)
nov15$species <- ifelse(nov15$species == "F pentagona", "F. pentagona", nov15$species)
nov15$species <- ifelse(nov15$species == "Favities", "Favites sp.", nov15$species)
nov15$species <- ifelse(nov15$species == "favites sp", "Favites sp.", nov15$species)
nov15$species <- ifelse(nov15$species == "Favia halicora", "Favites halicora", nov15$species)
nov15$species <- ifelse(nov15$species == "favia matthai", "Favia matthai", nov15$species)
nov15$species <- ifelse(nov15$species == "Hydno", "Hydnophora", nov15$species)
nov15$species <- ifelse(nov15$species == "platygyra sp.", "Platygyra sp.", nov15$species)

unique(nov15$species) 

unique(nov15$bleaching.proportion) #good to go

unique(nov15$cut.off.y.n) # good to go

head(nov15)

#ok now combine some of the species
nov15$species.comb <- nov15$species

nov15$species.comb <- ifelse((nov15$species == "Favia sp." | nov15$species == "Favia matthai"), "Favia spp", nov15$species.comb)

nov15$species.comb <- ifelse((nov15$species == "Favites halicora" | nov15$species == "Favites sp."), "Favites spp", nov15$species.comb)

unique(nov15$species.comb)

#add disturbance level
nov15$disturb <- "VH"
nov15$disturb <- ifelse(nov15$site == "8", "M", nov15$disturb)
nov15$disturb <- ifelse(nov15$site == "35", "M", nov15$disturb)
nov15$disturb <- ifelse(nov15$site == "BayofWrecks_Loggers", "VL", nov15$disturb)

unique(nov15$disturb)

head(nov15)

#add column of binary bleaching
nov15$bin.bleach <- 0
nov15$bin.bleach <- ifelse((nov15$bleaching.proportion == "3" | nov15$bleaching.proportion == "2"| nov15$bleaching.proportion == "1"), 1, nov15$bin.bleach)
head(nov15)
tail(nov15)

#determine order of levels
str(nov15)
nov15$disturb <- as.factor(nov15$disturb)
levels(nov15$disturb)
nov15$disturb<-factor(nov15$disturb, levels = c("VH", "M", "VL")) 
levels(nov15$disturb)

nov15$species.comb <- as.factor(nov15$species.comb)
levels(nov15$species.comb)
nov15$species.comb<-factor(nov15$species.comb, levels = c("Platygyra sp.", "F. pentagona",  "Favia spp", "Favid", "Favites spp", "Hydnophora")) 
levels(nov15$species.comb)

#make a table

nov.tbl <- plyr::count(nov15, c("site", "species.comb", "bleaching.proportion"))

nov.tbl

colnames(nov.tbl)<-c("site", "species.comb", "bleach.prop", "bleach.prop.freq")
str(nov.tbl)

#take out level 5
nov.tbl <- nov.tbl[!nov.tbl$bleach.prop == "5",]
nov.tbl <- droplevels(nov.tbl)

head(nov.tbl)

```
  
```{r prepping coral net data, include=FALSE}

head(coralnet)

#take out some columns I dont care about
cn <- subset(coralnet, select = c("Field.Season", "Site", "Quadrat", "adj.total.points.quadrat", "coralnet.tag", "Cover", "Bleached", "Species", "Fish.Level", "adj.total.points.site"))

#subset for 2015c, 2015d, and 2016a
cn <- cn[(cn$Field.Season == "KI2015c" | cn$Field.Season == "KI2015d" | cn$Field.Season == "KI2016a"), ]
cn <- droplevels(cn)
unique(cn$Field.Season)

#subset for sites with tagged coral
unique(cn$Site)
sitestokeep <- c("site14", "site15", "site19", "site25",  "site27", "site3",  "site30", "site32",  "site34", "site35",  "site37", "site38", "site40", "site5", "site8" )
cn <- cn[cn$Site%in%sitestokeep, ]
cn <- droplevels(cn)
unique(cn$Site)

#take site out of site column
cn$site <- cn$Site
str(cn$site)
cn$site <- as.character(levels(cn$site))[cn$site]
unique(cn$site)
cn$site <- ifelse(grepl("e3", cn$Site), "3", cn$site)
cn$site <- ifelse(grepl("e5", cn$Site), "5", cn$site)
cn$site <- ifelse(grepl("e8", cn$Site), "8", cn$site)
cn$site <- ifelse(grepl("e14", cn$Site), "14", cn$site)
cn$site <- ifelse(grepl("e15", cn$Site), "15", cn$site)
cn$site <- ifelse(grepl("e19", cn$Site), "19", cn$site)
cn$site <- ifelse(grepl("e25", cn$Site), "25", cn$site)
cn$site <- ifelse(grepl("e27", cn$Site), "27", cn$site)
cn$site <- ifelse(grepl("e30", cn$Site), "30", cn$site)
cn$site <- ifelse(grepl("e32", cn$Site), "32", cn$site)
cn$site <- ifelse(grepl("e34", cn$Site), "34", cn$site)
cn$site <- ifelse(grepl("e35", cn$Site), "35", cn$site)
cn$site <- ifelse(grepl("e37", cn$Site), "37", cn$site)
cn$site <- ifelse(grepl("e38", cn$Site), "38", cn$site)
cn$site <- ifelse(grepl("e40", cn$Site), "40", cn$site)

#subset for just the species I care about
unique(cn$coralnet.tag)
unique(cn$Species)
coralstokeep <- c("Favia.matthai", "Hydnophora.microconos", "Favia.spp", "Platygyra.spp", "Favites.halicora", "Favites.pentagona", "Favites.spp")
cn <- cn[cn$Species%in%coralstokeep, ]
cn <- droplevels(cn)
unique(cn$Species)

#Favia.spp and Favites.spp are not ever recorded so going to take them out
cn[(cn$Species == "Favia.spp" | cn$Species == "Favites.spp"),] # aka the cover is 0 for all of them
cn <- cn[!(cn$Species == "Favia.spp" | cn$Species == "Favites.spp"), ]
cn <- droplevels(cn)

head(cn)

#set order to some of the categories
str(cn)

cn$site <- as.factor(cn$site)
levels(cn$site)
cn$site<-factor(cn$site, levels = c("15", "19", "5", "37", "38", "3", "25", "8", "14", "35", "34", "40", "32", "30", "27"))
levels(cn$site)

levels(cn$Fish.Level)
cn$Fish.Level <- factor(cn$Fish.Level, levels = c("Very.Low", "Low", "Medium",  "High" , "Very.High"))
levels(cn$Fish.Level)

levels(cn$Species)
cn$Species <- factor(cn$Species, levels = c("Platygyra.spp", "Hydnophora.microconos", "Favites.pentagona",  "Favia.matthai", "Favia.spp", "Favites.halicora",  "Favites.spp"))
levels(cn$Species)

###now to create tables and calculate proportions etc

#by site
cn.sum.site<-aggregate(Cover ~  Species + site + Field.Season + Bleached, cn, sum)
head(cn.sum.site)

#calculate the number of points at each site for each species (healthy and bleached) so we can get proportion of bleached vr healthy
cn.sum.species.site <- aggregate(Cover ~ Species + site + Field.Season, cn, sum)
head(cn.sum.species.site)

#now add to the other dataframe 
cn.sum.site$season.site.spec <- paste(cn.sum.site$Field.Season, cn.sum.site$site, cn.sum.site$Species, sep = ".")
cn.sum.species.site$season.site.spec <- paste(cn.sum.species.site$Field.Season, cn.sum.species.site$site, cn.sum.species.site$Species, sep = ".")
cn.sum.site$adj.total.points.site.spec <- cn.sum.species.site$Cover[match(cn.sum.site$season.site.spec, cn.sum.species.site$season.site.spec)]
head(cn.sum.site)

#now calculate proportion
cn.sum.site$prop <- cn.sum.site$Cover/cn.sum.site$adj.total.points.site.spec
head(cn.sum.site)



#by disturbance 
cn.sum.disturb<-aggregate(Cover ~  Species + Fish.Level + Field.Season + Bleached, cn, sum)
head(cn.sum.disturb)

#now to calculate the number of points per disturbance by species
cn.ptsum.disturb.spec<-aggregate(Cover ~ Fish.Level + Field.Season + Species, cn, sum)
head(cn.ptsum.disturb.spec)

#add to other df
cn.ptsum.disturb.spec$season.fish.spec <- paste(cn.ptsum.disturb.spec$Field.Season, cn.ptsum.disturb.spec$Fish.Level, cn.ptsum.disturb.spec$Species, sep = ".")
cn.sum.disturb$season.fish.spec <- paste(cn.sum.disturb$Field.Season, cn.sum.disturb$Fish.Level, cn.sum.disturb$Species, sep = ".")
cn.sum.disturb$adj.total.points.fish.spec <- cn.ptsum.disturb.spec$Cover[match(cn.sum.disturb$season.fish.spec, cn.ptsum.disturb.spec$season.fish.spec)]
head(cn.sum.disturb)

#now calculate proportion
cn.sum.disturb$prop <- cn.sum.disturb$Cover/cn.sum.disturb$adj.total.points.fish.spec
head(cn.sum.disturb)

```
  
```{r color set up , include=FALSE}

bleachcols <- c("seagreen4", "seagreen3", "seagreen2", "darkseagreen1")

bleachcols2 <- c("seagreen4", "seagreen3", "seagreen2", "darkseagreen1", "deepskyblue3")


```
  
  
# i)  

## table of bleaching proportion  

```{r bleaching proportion table, echo=FALSE}

tblprob <- plyr::count(metalong.sp, c("year", "species.comb","bleach.prop"))

tblprob

```

## bar plots

```{r bleaching proportion figure proportion on x, echo=FALSE}

ggplot(tblprob, aes(x = bleach.prop, y = freq, fill = year)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~species.comb, scales = "free_y") 


```


```{r bleaching proportion figure proportion fill, echo=FALSE}

tblprob$bleach.prop <- as.character(tblprob$bleach.prop)

ggplot(tblprob, aes(x = year, y = freq, fill = bleach.prop)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~species.comb, scales = "free_y") + scale_fill_manual(values = bleachcols)


```

## statistics

**not bleached = 0   bleached (levels 1, 2, 3) = 1**  

site not included as random effect due to not enough sites within each disturbance level (it would not converge)  

```{r include=FALSE}
mean(metalong.sp15c$bin.bleach)
var(metalong.sp15c$bin.bleach)

```

```{r stats for i, echo=FALSE}

lr1 <- glm(bin.bleach ~ species.comb + disturb, family =  binomial(link = 'logit'), data = metalong.sp15c)

summary(lr1)

```


# ii)

```{r calculate things, include=FALSE}

#platy
nov.tbl.platy <- nov.tbl[nov.tbl$species.comb == "Platygyra sp.", ]

nov.tbl.platy

platysum <- sum(nov.tbl.platy$bleach.prop.freq)

nov15.platy <- nov15[nov15$species.comb == "Platygyra sp.",]

platy.disturb <- plyr::count(nov15.platy, c("disturb", "bleaching.proportion"))

platy.disturbsum <-  plyr::count(nov15.platy, c("disturb"))

platy <- plyr::count(nov15.platy$bleaching.proportion)

#hydno
nov.tbl.hydno <- nov.tbl[nov.tbl$species.comb == "Hydnophora", ]

nov.tbl.hydno

hydnosum <- sum(nov.tbl.hydno$bleach.prop.freq)

nov15.hydno <- nov15[nov15$species.comb == "Hydnophora",]

hydno.disturb <- plyr::count(nov15.hydno, c("disturb", "bleaching.proportion"))

hydno.distubsum <-  plyr::count(nov15.hydno, c("disturb"))

hydno <- plyr::count(nov15.hydno$bleaching.proportion)


#fpenta
nov.tbl.fpenta <- nov.tbl[nov.tbl$species.comb == "F. pentagona", ]

nov.tbl.fpenta

fpentasum <- sum(nov.tbl.hydno$bleach.prop.freq)

nov15.fpenta <- nov15[nov15$species.comb == "F. pentagona",]

fpenta.disturb <- plyr::count(nov15.fpenta, c("disturb", "bleaching.proportion"))

fpenta.distubsum <-  plyr::count(nov15.fpenta, c("disturb"))

fpenta <- plyr::count(nov15.fpenta$bleaching.proportion)


#favia
nov.tbl.favia <- nov.tbl[nov.tbl$species.comb == "Favia spp", ]

nov.tbl.favia

faviasum <- sum(nov.tbl.favia$bleach.prop.freq)

nov15.favia <- nov15[nov15$species.comb == "Favia spp",]

favia.disturb <- plyr::count(nov15.favia, c("disturb", "bleaching.proportion"))

favia.distubsum <-  plyr::count(nov15.favia, c("disturb"))

favia <- plyr::count(nov15.favia$bleaching.proportion)

#favid
nov.tbl.favid <- nov.tbl[nov.tbl$species.comb == "Favid", ]

nov.tbl.favid

favidsum <- sum(nov.tbl.favid$bleach.prop.freq)

nov15.favid <- nov15[nov15$species.comb == "Favid",]

favid.disturb <- plyr::count(nov15.favid, c("disturb", "bleaching.proportion"))

favid.distubsum <-  plyr::count(nov15.favid, c("disturb"))

favid <- plyr::count(nov15.favid$bleaching.proportion)

```

**Platy**  
In the photos from Kim Cobb from November 2015 there were s `r platysum` Platygyra. There were `r platy[1,2]` that were not showing any signs of bleaching. That is `r (platy[1,2]/platysum)*100`% of the Platys. Only `r platy[2,2]` had level 1 bleaching, `r platy[3,2]` had level 2, and `r platy[4,2]` had level 3.   

There were `r platy.disturbsum[1,2]` at medium disturbance sites - `r platy.disturb[1,3]` of them were healthy (`r (platy.disturb[1,3]/platy.disturbsum[1,2])*100`%). Only `r platy.disturb[3,3]` were full bleached (level 3). There were `r platy.disturbsum[2,2]` at VH sites - `r platy.disturb[5,3]` were not bleached and there were none that were fully bleached. There was only `r platy.disturbsum[3,2]` platy at VL sites but it was not bleached. There were not many photos from BOW though. 
  
**Hydno**  
In the photos from Kim Cobb from November 2015 there were s `r hydnosum` Hydnophora. There were `r hydno[1,2]` that were not showing any signs of bleaching. That is `r (hydno[1,2]/hydnosum)*100`% of the hydnos. Only `r hydno[2,2]` had level 1 bleaching, `r hydno[3,2]` had level 2, but `r hydno[4,2]` had level 3.   

There were `r hydno.distubsum[1,2]` at medium disturbance sites - `r hydno.disturb[1,3]` of them were healthy (`r (hydno.disturb[1,3]/hydno.distubsum[1,2])*100`%), `r hydno.disturb[4,3]` were full bleached (level 3) (`r (hydno.disturb[4,3]/hydno.distubsum[1,2])*100`%). There were `r hydno.distubsum[2,2]` at VH sites - `r hydno.disturb[6,3]` were not bleached and there were `r hydno.disturb[8,3]` fully bleached. There was only `r hydno.distubsum[3,2]` at VL sites but they were all fully bleached. There were not many photos from BOW though. 
  
**F. pentagona**  
In the photos from Kim Cobb from November 2015 there were s `r fpentasum` F. pentagona. There were `r fpenta[1,2]` that were not showing any signs of bleaching. That is `r (fpenta[1,2]/fpentasum)*100`% of the F. pentagona. Only `r fpenta[2,2]` had level 1 bleaching, `r fpenta[3,2]` had level 2, but `r fpenta[4,2]` had level 3.   

There were `r fpenta.distubsum[1,2]` at medium disturbance sites - `r fpenta.disturb[1,3]` of them were healthy (`r (fpenta.disturb[1,3]/fpenta.distubsum[1,2])*100`%), `r fpenta.disturb[4,3]` were full bleached (level 3) (`r (fpenta.disturb[4,3]/fpenta.distubsum[1,2])*100`%). There were `r fpenta.distubsum[2,2]` at VH sites - `r fpenta.disturb[6,3]` were not bleached and there were none fully bleached. There was only `r fpenta.distubsum[3,2]` at VL sites and it was a level 2 bleaching. There were not many photos from BOW though. 

**Favia spp**  
In the photos from Kim Cobb from November 2015 there were s `r faviasum` Favia spp. There were `r favia[1,2]` that were not showing any signs of bleaching. That is `r (favia[1,2]/faviasum)*100`% of the F. pentagona. Only `r favia[2,2]` had level 1 bleaching, `r favia[3,2]` had level 2, but `r favia[4,2]` had level 3.   

There were `r favia.distubsum[1,2]` at medium disturbance sites - `r favia.disturb[1,3]` of them were healthy (`r (favia.disturb[1,3]/favia.distubsum[1,2])*100`%), `r favia.disturb[4,3]` were full bleached (level 3) (`r (favia.disturb[4,3]/favia.distubsum[1,2])*100`%). There were `r favia.distubsum[2,2]` at VH sites - `r favia.disturb[6,3]` were not bleached and there `r favia.disturb[8,3]` fully bleached. There was only `r favia.distubsum[3,2]` at VL sites and it was a level 3 bleaching. There were not many photos from BOW though. 

**Favia spp**  
In the photos from Kim Cobb from November 2015 there were s `r favidsum` Favid. There were corals that I could tell were a favid but I was unable to tell if it was Favia or Favites. There were `r favid[1,2]` that were not showing any signs of bleaching. That is `r (favid[1,2]/favidsum)*100`% of the F. pentagona. Only `r favid[2,2]` had level 1 bleaching, `r favid[3,2]` had level 2, but `r favid[4,2]` had level 3.   

There were `r favid.distubsum[1,2]` at medium disturbance sites - `r favid.disturb[1,3]` of them were healthy (`r (favid.disturb[1,3]/favid.distubsum[1,2])*100`%), `r favid.disturb[4,3]` were full bleached (level 3) (`r (favid.disturb[4,3]/favid.distubsum[1,2])*100`%). There were `r favid.distubsum[2,2]` at VH sites - `r favid.disturb[7,3]` were not bleached and there `r favid.disturb[10,3]` fully bleached. There was none at the VL sites. There were not many photos from BOW though. 


## table of bleaching proportion in November 2015

```{r nov 15 table, echo=FALSE, paged.print=TRUE}

nov.tbl

```

## bar plots

### facet wrap by species  

```{r bleaching proportion figure nov 2015 facet by species, echo=FALSE}

ggplot(nov.tbl, aes(x = site, y = bleach.prop.freq, fill = bleach.prop)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~species.comb, scales = "free_y") +
  scale_fill_manual(values = bleachcols2)


```


### facet wrap by site 

```{r bleaching proportion figure nov 2015 facet by site, echo=FALSE}

ggplot(nov.tbl, aes(x = species.comb, y = bleach.prop.freq, fill = bleach.prop)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~site, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90)) +
  scale_fill_manual(values = bleachcols2)


```

## statistics

**not bleached = 0   bleached (levels 1, 2, 3) = 1**  

site not included as random effect due to not enough sites within each disturbance level (it would not converge)  

```{r include=FALSE}
mean(nov15$bin.bleach)
var(nov15$bin.bleach)

```

```{r stats for ii, echo=FALSE}

lr2 <- glm(bin.bleach ~ species.comb + disturb, family =  binomial(link = 'logit'), data = nov15)

summary(lr2)

```


# iii)

## bar plots  

### proportion bleached vrs healthy per field season across sites with tagged corals
  
```{r prop by site 2015c, echo=FALSE, warning=FALSE}

cn.sum.site15c <- cn.sum.site[cn.sum.site$Field.Season == "KI2015c", ]

ggplot(cn.sum.site15c, aes(x = site, y = prop, fill = Bleached)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~Species, scales = "free_y") +
  labs(title = "2015c")

```

    
```{r prop by site 2015d, echo=FALSE, warning=FALSE}

cn.sum.site15d <- cn.sum.site[cn.sum.site$Field.Season == "KI2015d", ]

ggplot(cn.sum.site15d, aes(x = site, y = prop, fill = Bleached)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~Species, scales = "free_y") +
  labs(title = "2015d")

```
  
  
```{r prop by site 2016a, echo=FALSE, warning=FALSE}

cn.sum.site16a <- cn.sum.site[cn.sum.site$Field.Season == "KI2016a", ]

ggplot(cn.sum.site16a, aes(x = site, y = prop, fill = Bleached)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~Species, scales = "free_y") +
  labs(title = "2016a")

```

### across disturbance gradient (again only sites that have tagged corals)

 
```{r prop by disturb 2015c, echo=FALSE, warning=FALSE}

cn.sum.disturb15c <- cn.sum.disturb[cn.sum.disturb$Field.Season == "KI2015c", ]

ggplot(cn.sum.disturb15c, aes(x = Fish.Level, y = prop, fill = Bleached)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~Species) +
  labs(title = "2015c")

```

    
```{r prop by disturb 2015d, echo=FALSE, warning=FALSE}

cn.sum.disturb15d <- cn.sum.disturb[cn.sum.disturb$Field.Season == "KI2015d", ]

ggplot(cn.sum.disturb15d, aes(x = Fish.Level, y = prop, fill = Bleached)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~Species) +
  labs(title = "2015d")

```
  
  
```{r prop by disturb 2016a, echo=FALSE, warning=FALSE}

cn.sum.disturb16a <- cn.sum.disturb[cn.sum.disturb$Field.Season == "KI2016a", ]

ggplot(cn.sum.disturb16a, aes(x = Fish.Level, y = prop, fill = Bleached)) + geom_bar(stat='identity', position='dodge') +
  facet_wrap(~Species) +
  labs(title = "2016a")

```


# iv)















