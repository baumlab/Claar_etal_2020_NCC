---
title: "KI_Platy_analysis_OTUSummary"
output: 
  html_document:
    toc: true
    toc_float: true
---

<!-- Setup, import libraries, and load RData -->
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(phyloseq)
library(data.table)
library(VennDiagram)
library(dplyr)
library(ggplot2)
library(gridExtra)
library(grid)
library(cowplot)



rm(list=ls())

load("C:/Users/Dani/Documents/Data_Analysis/KI_Platy/data/KI_seqs_f_coral_grouped.RData")

# Look at tax_table
tax_table(phy97.f.c)

mycols <- c("#d7191c", "#fdae61", "#ffffbf", "#abdda4", "#2b83ba")

palette(mycols)

clade.colors <- c(A = "#D55E00", C = "#009E73", D = "#56B4E9", F = "#E69F00", G = "#F0E442", Other = "#A9A9A9")

```

<!-- https://github.com/tidyverse/ggplot2/wiki/Share-a-legend-between-two-ggplot2-graphs -->
```{r include=FALSE}
grid_arrange_shared_legend <- function(..., ncol = length(list(...)), nrow = 1, position = c("bottom", "right")) {

  plots <- list(...)
  position <- match.arg(position)
  g <- ggplotGrob(plots[[1]] + theme(legend.position = position))$grobs
  legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]
  lheight <- sum(legend$height)
  lwidth <- sum(legend$width)
  gl <- lapply(plots, function(x) x + theme(legend.position="none"))
  gl <- c(gl, ncol = ncol, nrow = nrow)

  combined <- switch(position,
                     "bottom" = arrangeGrob(do.call(arrangeGrob, gl),
                                            legend,
                                            ncol = 1,
                                            heights = unit.c(unit(1, "npc") - lheight, lheight)),
                     "right" = arrangeGrob(do.call(arrangeGrob, gl),
                                           legend,
                                           ncol = 2,
                                           widths = unit.c(unit(1, "npc") - lwidth, lwidth)))

  grid.newpage()
  grid.draw(combined)

  # return gtable invisibly
  invisible(combined)

}
```


# Symbiont alpha-diversity - Grouped by Species  

First, we look at how many *Symbiodinium* types (OTUs) and clades are present in each coral species:

<!-- Calculate OTU and clade diversity by species -->
```{r, include=TRUE, echo=FALSE, cache=TRUE}
# PLATYGYRA  
# Number of OTUs:
platy.ntaxa <- ntaxa(phy97.f.c.platy)
# Number of Clades:
platy.nclades  <- sum(table(unlist(sort((unique((data.frame(tax_table(phy97.f.c.platy))[9])$clade))))))
platy.clades <- levels(unique((data.frame(tax_table(phy97.f.c.platy))[9])$clade))
# FAVITES PENTAGONA  
# Number of OTUs:
favites.ntaxa <- ntaxa(phy97.f.c.fpenta)
# Number of Clades:
favites.nclades <- sum(table(unlist(sort((unique((data.frame(tax_table(phy97.f.c.fpenta))[9])$clade))))))
favites.clades <- levels(unique((data.frame(tax_table(phy97.f.c.fpenta))[9])$clade))
# FAVIA  
# Number of OTUs:
favia.ntaxa <- ntaxa(phy97.f.c.faviaall)
# Number of Clades:
favia.nclades <- sum(table(unlist(sort((unique((data.frame(tax_table(phy97.f.c.faviaall))[9])$clade))))))
favia.clades <- levels(unique((data.frame(tax_table(phy97.f.c.faviaall))[9])$clade))
```

# Plot OTU and clade diversity by species
```{r, include=TRUE, echo=FALSE, cache=TRUE}
# Make a data frame including the number of OTUs
df <- data.frame(Platygyra=platy.ntaxa,Favia=favia.ntaxa,Favites=favites.ntaxa)
# Add the number of clades to the data frame
df[2,] <- c(platy.nclades,favia.nclades,favites.nclades)
# Set the row names
rownames(df) <- c("OTUs","Clades")
# Transpose the data frame
df <- t(df)
# Print the data frame
df

# Create and print a barplot of these data
barplot(df, names.arg=c("OTUs","Clades"), beside=TRUE, legend=rownames(df), col=c("deepskyblue4","lightblue","darkcyan"),ylim = c(0,max(df)))

# Create a pdf of this plot and save in the 'figures' folder
# Open a new pdf file
pdf(file="C:/Users/Dani/Documents/Data_Analysis/KI_Platy/figures/OTUSummary/Diversity_by_Species.pdf")
# Make the plot
barplot(df, names.arg=c("OTUs","Clades"), beside=TRUE, legend=rownames(df), col=c("deepskyblue4","lightblue","darkcyan"),ylim = c(0,max(df)))
# Close the pdf file
dev.off()

```

# Sample sizes for different coral taxa
```{r, include=TRUE, echo=FALSE, cache=TRUE}
# Number of samples - PLATYGYRA SP.
sum(sample_data(phy97.f.c.coral)$Coral_Species=="Platygyra_sp")
# Number of tagged colonies - PLATYGYRA SP.
unique(sample_data(phy97.f.c.platy)$CoralTag)
#  PLATYGYRA SP.
p1 <- plot_bar(phy97.f.c.platy.p,fill="hit",title = "Platygyra") 
# + scale_fill_manual(values=c(
#   "#a6bddb","#74a9cf","#3690c0","#0570b0", # Clade A
# "#fdd0a2","#fdae6b","#fd8d3c","#f16913","#d94801","#a63603","#7f2704","#a50f15","#cb181d","#ef3b2c","#fb6a4a","#fc9272", # Clade C
# "#fcbba1",  "#74c476","#41ab5d", # Clade D
#   "yellow", # Clade F
#   "purple")) # Clade G

# Number of samples - FAVITES PENTAGONA
sum(sample_data(phy97.f.c.coral)$Coral_Species=="Favites_pentagona")
# Number of tagged colonies - FAVITES PENTAGONA
unique(sample_data(phy97.f.c.fpenta)$CoralTag)
#  FAVITES PENTAGONA
p2 <- plot_bar(phy97.f.c.fpenta.p,fill="hit",title="Favites pentagona")
#+ scale_fill_manual(values=c(
#   "#a6bddb","#74a9cf","#3690c0","#0570b0", # Clade A
# "#fdd0a2","#fdae6b","#fd8d3c","#f16913","#d94801","#a63603","#7f2704","#a50f15","#cb181d","#ef3b2c","#fb6a4a","#fc9272", # Clade C
# "#fcbba1",  "#74c476","#41ab5d", # Clade D
#   "yellow", # Clade F
#   "purple")) # Clade G

# # Number of samples - FAVIA MATTHAI
# sum(sample_data(phy97.f.c.coral)$Coral_Species=="Favia_matthai")
# # Number of tagged colonies - FAVIA MATTHAI
# unique(sample_data(phy97.f.c.faviam)$CoralTag)
# #  FAVIA MATTHAI
# p3 <- plot_bar(phy97.f.c.faviam.p,fill="hit", title="Favia matthai")

# Write new figure to pdf
jpeg(file="C:/Users/Dani/Documents/Data_Analysis/KI_Platy/figures/OTUSummary/Combined_Barplot.jpg",height=9, width=14,units = "in", res=300)
# Plot Platygyra and Favites pentagona with a shared legend
grid_arrange_shared_legend(p1, p2, ncol = 1, nrow = 2)
dev.off()

jpeg(file="C:/Users/Dani/Documents/Data_Analysis/KI_Platy/figures/OTUSummary/Combined_Barplot_byclade.jpg",height=9, width=14,units="in",res=300)
p4 <- plot_bar(phy97.f.c.platy.p,fill="clade",title = "Platygyra")
p5 <- plot_bar(phy97.f.c.fpenta.p,fill="clade",title="Favites pentagona")
grid_arrange_shared_legend(p4, p5, ncol = 1, nrow = 2)
dev.off()

```

Barplot by *Symbiodinium* Clade - Platygyra and Favites pentagona
![Combined barplot by clade](../figures/OTUSummary/Combined_Barplot_byclade.jpg)


Barplot by *Symbiodinium* Hit - Platygyra and Favites pentagona
![Combined barplot by Hit](../figures/OTUSummary/Combined_Barplot.jpg)



# Symbiont alpha-diversity - Grouped by Sites (and SampleType)  

  
Next, we look at the number of *Symbiodinium* types (OTUs) and clades in coral at each Kiritimati site:  

<!-- Calculate OTU and clade diversity by site -->
```{r, include=TRUE, echo=FALSE, cache=TRUE}
for (i in unique(data.frame(sample_data(phy97.f.c.coral))$Site)){
  nam <- paste("site",i,".coral.ntaxa",sep="")
  nam2 <- paste("site",i,".coral.nclades",sep="")
  nam3 <- paste("site",i,".coral.clades",sep="")
  nam4 <- paste("site",i,".coral.hits",sep="")
  ornam <- get(paste("phy97.f.c.coral.site",i,sep=""))
  a <- eval(ntaxa(ornam))
  assign(nam,a)
  b <- eval(sum(table(unlist(sort((unique((data.frame(tax_table(ornam))[9])$clade)))))))
  assign(nam2,b)
  c <- eval(levels(unique((data.frame(tax_table(ornam))[9])$clade)))
  assign(nam3,c)
  d <- eval(length((unique(data.frame(tax_table(ornam))$hit))))
  assign(nam4,d)
}

for (i in unique(data.frame(sample_data(phy97.f.c.platy))$Site)){
  nam <- paste("site",i,".platy.ntaxa",sep="")
  nam2 <- paste("site",i,".platy.nclades",sep="")
  nam3 <- paste("site",i,".platy.clades",sep="")
  nam4 <- paste("site",i,".platy.hits",sep="")
  ornam <- get(paste("phy97.f.c.platy.site",i,sep=""))
  a <- eval(ntaxa(ornam))
  assign(nam,a)
  b <- eval(sum(table(unlist(sort((unique((data.frame(tax_table(ornam))[9])$clade)))))))
  assign(nam2,b)
  c <- eval(levels(unique((data.frame(tax_table(ornam))[9])$clade)))
  assign(nam3,c)
  d <- eval(length((unique(data.frame(tax_table(ornam))$hit))))
  assign(nam4,d)
}

for (i in unique(data.frame(sample_data(phy97.f.c.fpenta))$Site)){
  nam <- paste("site",i,".fpenta.ntaxa",sep="")
  nam2 <- paste("site",i,".fpenta.nclades",sep="")
  nam3 <- paste("site",i,".fpenta.clades",sep="")
  nam4 <- paste("site",i,".fpenta.hits",sep="")
  ornam <- get(paste("phy97.f.c.fpenta.site",i,sep=""))
  a <- eval(ntaxa(ornam))
  assign(nam,a)
  b <- eval(sum(table(unlist(sort((unique((data.frame(tax_table(ornam))[9])$clade)))))))
  assign(nam2,b)
  c <- eval(levels(unique((data.frame(tax_table(ornam))[9])$clade)))
  assign(nam3,c)
  d <- eval(length((unique(data.frame(tax_table(ornam))$hit))))
  assign(nam4,d)
}

```

# OTU and Clade Diversity by Site
```{r, include=TRUE, echo=FALSE, cache=TRUE}
df2 <- data.frame(site3=site3.coral.ntaxa,site5=site5.coral.ntaxa,site8=site8.coral.ntaxa,site14=site14.coral.ntaxa,site15=site15.coral.ntaxa,site19=site19.coral.ntaxa,site25=site25.coral.ntaxa,site27=site27.coral.ntaxa,site30=site30.coral.ntaxa,site32=site32.coral.ntaxa,site34=site34.coral.ntaxa,site35=site35.coral.ntaxa,site37=site37.coral.ntaxa,site38=site38.coral.ntaxa,site40=site40.coral.ntaxa)
df2[2,] <- c(site3.coral.nclades,site5.coral.nclades,site8.coral.nclades,site14.coral.nclades,site15.coral.nclades,site19.coral.nclades,site25.coral.nclades,site27.coral.nclades,site30.coral.nclades,site32.coral.nclades,site34.coral.nclades,site35.coral.nclades,site37.coral.nclades,site38.coral.nclades,site40.coral.nclades)
df2[3,] <- c(2,5,3,3,6,6,2,1,1,1,3,3,5,2,1)
df2[4,] <- c(site3.coral.hits,site5.coral.hits,site8.coral.hits,site14.coral.hits,site15.coral.hits,site19.coral.hits,site25.coral.hits,site27.coral.hits,site30.coral.hits,site32.coral.hits,site34.coral.hits,site35.coral.hits,site37.coral.hits,site38.coral.hits,site40.coral.hits)
rownames(df2) <- c("OTUs","Clades", "Dist", "Subclades")
df2 <- t(df2)
df2 <- df2[order(df2[,3]),]
df2


par(xpd=TRUE,mar=c(3,3,3,11))
barplot(df2[,c(1,4,2)], names.arg=c("OTUs","Subclades","Clades"), beside=TRUE, col=df2[,3],ylim = c(0,max(df2)),main="Symbiodinium Alpha Diversity - All Corals by Site")
legend("topright", inset=c(0.05,-0.05), legend=rownames(df2), fill=df2[,3],cex=0.55)


## Now for platy only
df2platy <- data.frame(site3=site3.platy.ntaxa,site5=site5.platy.ntaxa,site8=site8.platy.ntaxa,site14=site14.platy.ntaxa,site15=site15.platy.ntaxa,site25=site25.platy.ntaxa,site27=site27.platy.ntaxa,site30=site30.platy.ntaxa,site32=site32.platy.ntaxa,site34=site34.platy.ntaxa,site35=site35.platy.ntaxa,site37=site37.platy.ntaxa,site38=site38.platy.ntaxa,site40=site40.platy.ntaxa)
df2platy[2,] <- c(site3.platy.nclades,site5.platy.nclades,site8.platy.nclades,site14.platy.nclades,site15.platy.nclades,site25.platy.nclades,site27.platy.nclades,site30.platy.nclades,site32.platy.nclades,site34.platy.nclades,site35.platy.nclades,site37.platy.nclades,site38.platy.nclades,site40.platy.nclades)
df2platy[3,] <- c(2,5,3,3,6,2,1,1,1,3,3,5,2,1)
df2platy[4,] <- c(site3.platy.hits,site5.platy.hits,site8.platy.hits,site14.platy.hits,site15.platy.hits,site25.platy.hits,site27.platy.hits,site30.platy.hits,site32.platy.hits,site34.platy.hits,site35.platy.hits,site37.platy.hits,site38.platy.hits,site40.platy.hits)
rownames(df2platy) <- c("OTUs","Clades", "Dist", "Subclades")
df2platy <- t(df2platy)
df2platy <- df2platy[order(df2platy[,3]),]
df2platy

par(xpd=TRUE,mar=c(3,3,3,11))
barplot(df2platy[,c(1,4,2)], names.arg=c("OTUs","Subclades","Clades"), beside=TRUE, col=df2platy[,3],ylim = c(0,max(df2)),main="Symbiodinium Alpha Diversity - Platygyra by Site")
legend("topright", inset=c(0.05,-0.05), legend=rownames(df2platy), fill=df2platy[,3],cex=0.55)

## Now for fpenta only
df2fpenta <- data.frame(site3=site3.fpenta.ntaxa,site5=site5.fpenta.ntaxa,site8=site8.fpenta.ntaxa,site14=site14.fpenta.ntaxa,site15=site15.fpenta.ntaxa,site19=site19.fpenta.ntaxa,site25=site25.fpenta.ntaxa,site27=site27.fpenta.ntaxa,site30=site30.fpenta.ntaxa,site32=site32.fpenta.ntaxa,site34=site34.fpenta.ntaxa,site35=site35.fpenta.ntaxa,site37=site37.fpenta.ntaxa,site38=site38.fpenta.ntaxa,site40=site40.fpenta.ntaxa)
df2fpenta[2,] <- c(site3.fpenta.nclades,site5.fpenta.nclades,site8.fpenta.nclades,site14.fpenta.nclades,site15.fpenta.nclades,site19.fpenta.nclades,site25.fpenta.nclades,site27.fpenta.nclades,site30.fpenta.nclades,site32.fpenta.nclades,site34.fpenta.nclades,site35.fpenta.nclades,site37.fpenta.nclades,site38.fpenta.nclades,site40.fpenta.nclades)
df2fpenta[3,] <- c(2,5,3,3,6,6,2,1,1,1,3,3,5,2,1)
df2fpenta[4,] <- c(site3.fpenta.hits,site5.fpenta.hits,site8.fpenta.hits,site14.fpenta.hits,site15.fpenta.hits,site19.fpenta.hits,site25.fpenta.hits,site27.fpenta.hits,site30.fpenta.hits,site32.fpenta.hits,site34.fpenta.hits,site35.fpenta.hits,site37.fpenta.hits,site38.fpenta.hits,site40.fpenta.hits)
rownames(df2fpenta) <- c("OTUs","Clades", "Dist", "Subclades")
df2fpenta <- t(df2fpenta)
df2fpenta <- df2fpenta[order(df2fpenta[,3]),]
df2fpenta

par(xpd=TRUE,mar=c(3,3,3,11))
barplot(df2fpenta[,c(1,4,2)], names.arg=c("OTUs","Subclades","Clades"), beside=TRUE, col=df2fpenta[,3],ylim = c(0,max(df2)),main="Symbiodinium Alpha Diversity - F. pentagona by Site")
legend("topright", inset=c(0.05,-0.05), legend=rownames(df2fpenta), fill=df2fpenta[,3],cex=0.55)

```


 <!-- Calculate OTU and clade diversity by Disturbance level -->
```{r, include=TRUE, echo=FALSE, cache=TRUE}
for (i in unique(data.frame(sample_data(phy97.f.c.coral))$Dist)){
  nam <- paste(i,".coral.ntaxa",sep="")
  nam2 <- paste(i,".coral.nclades",sep="")
  nam3 <- paste(i,".coral.clades",sep="")
  nam4 <- paste(i,".coral.hits",sep="")
  ornam <- get(paste("phy97.f.c.coral.",i,sep=""))
  a <- eval(ntaxa(ornam))
  assign(nam,a)
  b <- eval(sum(table(unlist(sort((unique((data.frame(tax_table(ornam))[9])$clade)))))))
  assign(nam2,b)
  c <- eval(levels(unique((data.frame(tax_table(ornam))[9])$clade)))
  assign(nam3,c)
  d <- eval(length((unique(data.frame(tax_table(ornam))$hit))))
  assign(nam4,d)
}

for (i in unique(data.frame(sample_data(phy97.f.c.platy))$Dist)){
  nam <- paste(i,".platy.ntaxa",sep="")
  nam2 <- paste(i,".platy.nclades",sep="")
  nam3 <- paste(i,".platy.clades",sep="")
  nam4 <- paste(i,".platy.hits",sep="")
  ornam <- get(paste("phy97.f.c.platy.",i,sep=""))
  a <- eval(ntaxa(ornam))
  assign(nam,a)
  b <- eval(sum(table(unlist(sort((unique((data.frame(tax_table(ornam))[9])$clade)))))))
  assign(nam2,b)
  c <- eval(levels(unique((data.frame(tax_table(ornam))[9])$clade)))
  assign(nam3,c)
  d <- eval(length((unique(data.frame(tax_table(ornam))$hit))))
  assign(nam4,d)
}

for (i in unique(data.frame(sample_data(phy97.f.c.fpenta))$Dist)){
  nam <- paste(i,".fpenta.ntaxa",sep="")
  nam2 <- paste(i,".fpenta.nclades",sep="")
  nam3 <- paste(i,".fpenta.clades",sep="")
  nam4 <- paste(i,".fpenta.hits",sep="")
  ornam <- get(paste("phy97.f.c.fpenta.",i,sep=""))
  a <- eval(ntaxa(ornam))
  assign(nam,a)
  b <- eval(sum(table(unlist(sort((unique((data.frame(tax_table(ornam))[9])$clade)))))))
  assign(nam2,b)
  c <- eval(levels(unique((data.frame(tax_table(ornam))[9])$clade)))
  assign(nam3,c)
  d <- eval(length((unique(data.frame(tax_table(ornam))$hit))))
  assign(nam4,d)
}

```

# OTU and Clade Diversity by Disturbance Level
```{r, include=TRUE, echo=FALSE, cache=TRUE}
mycols <- c("#d7191c", "#fdae61", "#ffffbf", "#abdda4", "#2b83ba")
palette(mycols)

df2dist <- data.frame(VeryHigh=VeryHigh.coral.ntaxa, High=High.coral.ntaxa, HighMed=HighMed.coral.ntaxa, Low=Low.coral.ntaxa, VeryLow=VeryLow.coral.ntaxa)
df2dist[2,] <- c(VeryHigh.coral.hits,High.coral.hits,HighMed.coral.hits,Low.coral.hits,VeryLow.coral.hits)
df2dist[3,] <- c(VeryHigh.coral.nclades,High.coral.nclades,HighMed.coral.nclades,Low.coral.nclades,VeryLow.coral.nclades)
rownames(df2dist) <- c("OTUs","Clades", "Subclades")
df2dist <- t(df2dist)

par(xpd=TRUE,mar=c(3,3,3,3))
barplot(df2dist[,c(1:3)], names.arg=c("OTUs","Subclades","Clades"), beside=TRUE, col=mycols, ylim = c(0,max(df2dist)), main="Symbiodinium Alpha Diversity - All Corals by Disturbance")
legend("topright", inset=c(0.05,-0.05), legend=rownames(df2dist), fill=mycols,cex=0.55)


## Now for platy only
df2dist.platy <- data.frame(VeryHigh=VeryHigh.platy.ntaxa, High=High.platy.ntaxa, HighMed=HighMed.platy.ntaxa, Low=Low.platy.ntaxa, VeryLow=VeryLow.platy.ntaxa)
df2dist.platy[2,] <- c(VeryHigh.platy.hits,High.platy.hits,HighMed.platy.hits,Low.platy.hits,VeryLow.platy.hits)
df2dist.platy[3,] <- c(VeryHigh.platy.nclades,High.platy.nclades,HighMed.platy.nclades,Low.platy.nclades,VeryLow.platy.nclades)
rownames(df2dist.platy) <- c("OTUs","Clades", "Subclades")
df2dist.platy <- t(df2dist.platy)

par(xpd=TRUE,mar=c(3,3,3,3))
barplot(df2dist.platy[,c(1:3)], names.arg=c("OTUs","Subclades","Clades"), beside=TRUE, col=mycols, ylim = c(0,max(df2dist)), main="Symbiodinium Alpha Diversity - Platygyra by Disturbance")
legend("topright", inset=c(0.05,-0.05), legend=rownames(df2dist.platy), fill=mycols,cex=0.55)

## Now for fpenta only
df2dist.fpenta <- data.frame(VeryHigh=VeryHigh.fpenta.ntaxa, High=High.fpenta.ntaxa, HighMed=HighMed.fpenta.ntaxa, Low=Low.fpenta.ntaxa, VeryLow=VeryLow.fpenta.ntaxa)
df2dist.fpenta[2,] <- c(VeryHigh.fpenta.hits,High.fpenta.hits,HighMed.fpenta.hits,Low.fpenta.hits,VeryLow.fpenta.hits)
df2dist.fpenta[3,] <- c(VeryHigh.fpenta.nclades,High.fpenta.nclades,HighMed.fpenta.nclades,Low.fpenta.nclades,VeryLow.fpenta.nclades)
rownames(df2dist.fpenta) <- c("OTUs","Clades", "Subclades")
df2dist.fpenta <- t(df2dist.fpenta)

par(xpd=TRUE,mar=c(3,3,3,3))
barplot(df2dist.fpenta[,c(1:3)], names.arg=c("OTUs","Subclades","Clades"), beside=TRUE, col=mycols, ylim = c(0,max(df2dist)), main="Symbiodinium Alpha Diversity - F. pentagona by Disturbance")
legend("topright", inset=c(0.05,-0.05), legend=rownames(df2dist.fpenta), fill=mycols,cex=0.55)

```
 
# Symbiont alpha-diversity - Grouped by Field Season  
  
To understand how *Symbiodinium* diversity changes among field seasons, clade diversity is divided by field season. This includes coral-associated *Symbiodinium*.  
  
<!-- Calculate OTU and clade diversity by field season -->
```{r, include=TRUE, echo=FALSE, cache=TRUE}
# 2014  
# Number of OTUs:
s2014.ntaxa <- ntaxa(phy97.f.c.coral.2014)
# Number of Clades:
s2014.nclades  <- sum(table(unlist(sort((unique((data.frame(tax_table(phy97.f.c.coral.2014))[9])$clade))))))
s2014.clades <- levels(unique((data.frame(tax_table(phy97.f.c.coral.2014))[9])$clade))

# 2015 Jan
# Number of OTUs:
s2015Jan.ntaxa <- ntaxa(phy97.f.c.coral.2015Jan)
# Number of Clades:
s2015Jan.nclades  <- sum(table(unlist(sort((unique((data.frame(tax_table(phy97.f.c.coral.2015Jan))[9])$clade))))))
s2015Jan.clades <- levels(unique((data.frame(tax_table(phy97.f.c.coral.2015Jan))[9])$clade))

# 2015 May
# Number of OTUs:
s2015May.ntaxa <- ntaxa(phy97.f.c.coral.2015May)
# Number of Clades:
s2015May.nclades  <- sum(table(unlist(sort((unique((data.frame(tax_table(phy97.f.c.coral.2015May))[9])$clade))))))
s2015May.clades <- levels(unique((data.frame(tax_table(phy97.f.c.coral.2015May))[9])$clade))

# 2015 July
# Number of OTUs:
s2015July.ntaxa <- ntaxa(phy97.f.c.coral.2015July)
# Number of Clades:
s2015July.nclades  <- sum(table(unlist(sort((unique((data.frame(tax_table(phy97.f.c.coral.2015July))[9])$clade))))))
s2015July.clades <- levels(unique((data.frame(tax_table(phy97.f.c.coral.2015July))[9])$clade))

# 2016 March
# Number of OTUs:
s2016March.ntaxa <- ntaxa(phy97.f.c.coral.2016March)
# Number of Clades:
s2016March.nclades  <- sum(table(unlist(sort((unique((data.frame(tax_table(phy97.f.c.coral.2016March))[9])$clade))))))
s2016March.clades <- levels(unique((data.frame(tax_table(phy97.f.c.coral.2016March))[9])$clade))
```

# OTU and Clade Diversity by Field Season
```{r, include=TRUE, echo=FALSE, cache=TRUE}
mycols <- c("lightblue2", "lightblue2", "lightblue2", "orange", "red")
palette(mycols)
# Make a data frame for plotting OTU and clade diversity by Field Season
df3 <- data.frame(s2014=s2014.ntaxa,s2015Jan=s2015Jan.ntaxa,s2015May=s2015May.ntaxa,s2015July=s2015July.ntaxa,s2016March=s2016March.ntaxa)
df3[2,] <- c(s2014=s2014.nclades,s2015Jan=s2015Jan.nclades,s2015May=s2015May.nclades,s2015July=s2015July.nclades,s2016March=s2016March.nclades)
rownames(df3) <- c("OTUs","Clades")
df3 <- t(df3)
# Print the data frame
df3

# Make the plot in the RMD document
par(xpd=TRUE)
barplot(df3, names.arg=c("OTUs","Clades"), beside=TRUE, col=mycols,ylim = c(0,max(df3)), main="Symbiodinium Alpha Diversity - by Field Season")
legend("topright", legend=rownames(df3), fill=mycols, cex=0.7)

```


The overall number of OTUs and clades observed during each field season were equal, showing stable diversity at the ecosystem (or meta-community) level.

# Plot unique Symbiont types by coral taxa
```{r, include=TRUE, echo=FALSE, cache=TRUE}
# Platygyra
# Number of Symbiodinium Types:
platy.ntaxa <- length(unique(data.frame(tax_table(phy97.f.c.platy))$hit))
platy.ntaxa.before <- length(unique(data.frame(tax_table(phy97.f.c.platy.AD.before))$hit))
platy.ntaxa.durAft <- length(unique(data.frame(tax_table(phy97.f.c.platy.AD.da))$hit))
# Total 
platy.ntaxa
# Before the event
platy.ntaxa.before
# During/after the event
platy.ntaxa.durAft

# Favites pentagona
# Number of Symbiodinium Types:
fpenta.ntaxa <- length(unique(data.frame(tax_table(phy97.f.c.fpenta))$hit))
fpenta.ntaxa.before <- length(unique(data.frame(tax_table(phy97.f.c.fpenta.AD.before))$hit))
fpenta.ntaxa.durAft <- length(unique(data.frame(tax_table(phy97.f.c.fpenta.AD.da))$hit))
# Total 
fpenta.ntaxa
# Before the event
fpenta.ntaxa.before
# During/after the event
fpenta.ntaxa.durAft

df4 <- t(data.frame("Platy all"= platy.ntaxa, "Platy before"=platy.ntaxa.before, "Platy during/after"=platy.ntaxa.durAft,"FPenta all"=fpenta.ntaxa,"Fpenta before"= fpenta.ntaxa.before, "FPenta during/after"=fpenta.ntaxa.durAft))
# Make the plot in the RMD document
par(xpd=TRUE,mar=c(3,3,3,11))
barplot(df4, names.arg=c("Platy all","Platy before", "Platy during/after","FPenta all", "Fpenta before","FPenta during/after"), beside=TRUE, col=c("deepskyblue4","deepskyblue4","deepskyblue4","lightblue","lightblue","lightblue"), ylim = c(0,max(df4)))
legend(7.1,20, legend=rownames(df4), fill=c("deepskyblue4","deepskyblue4","deepskyblue4","lightblue","lightblue","lightblue"), cex=0.7)

```

# Principal and Background Types  

Background *Symbiodinium* types are those which have <0.01% abundance, and Principal *Symbiodinium* types are those which ahve >0.01% abunance (per Quigley et al 2017).  
  
Looking at coral samples only:  
<!-- Principal and Background Types - Corals -->
```{r, include=TRUE, echo=FALSE, cache=TRUE}
# Define the principal coral types
principal.coral.A <- sum(data.frame(tax_table(principal.coral))$clade=="A")
principal.coral.C <- sum(data.frame(tax_table(principal.coral))$clade=="C")
principal.coral.D <- sum(data.frame(tax_table(principal.coral))$clade=="D")
principal.coral.F <- sum(data.frame(tax_table(principal.coral))$clade=="F")
principal.coral.G <- sum(data.frame(tax_table(principal.coral))$clade=="G")
principal.coral.I <- sum(data.frame(tax_table(principal.coral))$clade=="I")

# Print Principal coral types
print("PRINCIPAL CORAL TYPES")

# Define principal coral clades
principal.coral.clades <- c(A=principal.coral.A,C=principal.coral.C,D=principal.coral.D,F=principal.coral.F,G=principal.coral.G,I=principal.coral.I)

# List and print principal coral types
principal.coral.types <- data.frame(tax_table(principal.coral))$hit
principal.coral.types

# Define Background Types
background.coral.A <- sum(data.frame(tax_table(background.coral))$clade=="A")
background.coral.C <- sum(data.frame(tax_table(background.coral))$clade=="C")
background.coral.D <- sum(data.frame(tax_table(background.coral))$clade=="D")
background.coral.F <- sum(data.frame(tax_table(background.coral))$clade=="F")
background.coral.G <- sum(data.frame(tax_table(background.coral))$clade=="G")
background.coral.I <- sum(data.frame(tax_table(background.coral))$clade=="I")

# Print "Background Coral Types"
print("BACKGROUND CORAL TYPES")

# Define Background Clades
background.coral.clades <- c(A=background.coral.A,C=background.coral.C,D=background.coral.D,F=background.coral.F,G=background.coral.G,I=background.coral.I)

# List and print background types
background.coral.types <- data.frame(tax_table(background.coral))$hit
background.coral.types

# Create data frame of background and principal coral clades
principal.coral.background.coral.clades <- rbind(principal.coral.clades,background.coral.clades)
t.principal.coral.background.coral.clades <- t(principal.coral.background.coral.clades)
colnames(t.principal.coral.background.coral.clades) <- c("Principal.coral Types", "Background.coral Types")

# Plot background and principal coral clades
barplot(t.principal.coral.background.coral.clades,col=rainbow(6),beside=TRUE, ylim=c(0,max(t.principal.coral.background.coral.clades)), main="Coral only")
legend("topleft", legend=rownames(t.principal.coral.background.coral.clades), fill=rainbow(6))

# Make pdf of background and principal coral clades
pdf(file="C:/Users/Dani/Documents/Data_Analysis/KI_Platy/figures/OTUSummary/Background.coral_Pricipal_Clades.pdf", width=10, height=7)
par(xpd=TRUE)
barplot(t.principal.coral.background.coral.clades,col=rainbow(6),beside=TRUE, ylim=c(0,max(t.principal.coral.background.coral.clades)), main="Coral only")
legend("topleft", legend=rownames(t.principal.coral.background.coral.clades), fill=rainbow(6))
dev.off()
```
  

# Core vs. Common vs. Rare
```{r, include=TRUE, echo=FALSE, cache=TRUE}
# Extract OTU names from Coral core, common, and rare types
names.coral.core <- names(coral.core)
names.coral.common <- names(coral.common)
names.coral.rare <- names(coral.rare)
```
  
# Print hits for core, common, and rare in coral
```{r, include=TRUE, echo=FALSE, cache=TRUE}
if (!is.null(names.coral.core)) {
  coral.core.hits <- data.frame()
  for (i in names.coral.core){
    coral.core.hits[i,1] <- paste((data.frame(tax_table(phy97.f.c.coral)))[i,]$hit)
  }
  colnames(coral.core.hits) <- "hits"
  print("coral.core.hits")
  coral.core.hits
} else {
  print("There were no core hits (for coral)")
}

if (!is.null(names.coral.common)) {
  coral.common.hits <- data.frame()
  for (i in names.coral.common){
    coral.common.hits[i,1] <- paste((data.frame(tax_table(phy97.f.c.coral)))[i,]$hit)
  }
  colnames(coral.common.hits) <- "hits"
  print("coral.common.hits")
  coral.common.hits
} else {
  print("There were no common hits (for coral)")
}

if (!is.null(names.coral.rare)) {
  coral.rare.hits <- data.frame()
  for (i in names.coral.rare){
    coral.rare.hits[i,1] <- paste((data.frame(tax_table(phy97.f.c.coral)))[i,]$hit)
  }
  colnames(coral.rare.hits) <- "hits"
  print("coral.rare.hits")
  coral.rare.hits
} else {
  print("There were no rare hits (for coral)")
}

```

# Abundance vs. Prevalence

<!-- Abundance vs. prevalence - Coral -->
```{r, include=TRUE, echo=FALSE, cache=TRUE}
# This is abundance
phy97.f.c.coral.otuAbundance <- data.frame(otuAbundance = taxa_sums(phy97.f.c.coral))
# This is prevalence
phy97.f.c.coral.otuPrevalence <- data.frame(otuPrevalence = (rowSums(sign(data.frame(otu_table(phy97.f.c.coral))))/(nrow(sample_data(phy97.f.c.coral)))))

phy97.f.c.coral.AbundPrev <- cbind(log(phy97.f.c.coral.otuAbundance),phy97.f.c.coral.otuPrevalence,hit=(data.frame(tax_table(phy97.f.c.coral)))$hit,clade=(data.frame(tax_table(phy97.f.c.coral)))$clade)

palette(rainbow(5))
plot(phy97.f.c.coral.AbundPrev[,1:2],xlab="Log OTU Abundance",ylab="OTU Prevalence", main="Coral",col=phy97.f.c.coral.AbundPrev$clade, pch=16)
# legend("topleft",inset=c(0.05,0.05), legend=phy97.f.c.coral.AbundPrev$hit, fill=phy97.f.c.coral.AbundPrev$clade, cex=0.5, text.width=2.5, ncol=3, xpd=TRUE)
```

# Rank Abundance Curves - all timepoints
```{r, include=TRUE, echo=FALSE, cache=TRUE}
par(mar=c(12,5,1,1),xaxs="i",yaxs="i",mfrow=c(1,3))
N=15

# All corals
rac.temp <- data.frame(sort(taxa_sums(phy97.f.c.coral)))
rac.temp$otu<-rownames(rac.temp)
colnames(rac.temp)[1] <- "Abundance"
rac <- merge(rac.temp, data.frame(tax_table(phy97.f.c.coral)), by="otu")
rac <- rac[order(-rac$Abundance),]

barplot(rac$Abundance[1:N], las=2, names.arg=rac$hit[1:N],space=0,col=rac$clade,main="All Corals")

# Platygyra
rac.platy.temp <- data.frame(sort(taxa_sums(phy97.f.c.platy)))
rac.platy.temp$otu<-rownames(rac.platy.temp)
colnames(rac.platy.temp)[1] <- "Abundance"
rac.platy <- merge(rac.platy.temp, data.frame(tax_table(phy97.f.c.platy)), by="otu")
rac.platy <- rac.platy[order(-rac.platy$Abundance),]

barplot(rac.platy$Abundance[1:N], las=2, names.arg=rac.platy$hit[1:N],space=0,col=rac.platy$clade,main="Platygyra")

# FPenta
rac.fpenta.temp <- data.frame(sort(taxa_sums(phy97.f.c.fpenta)))
rac.fpenta.temp$otu<-rownames(rac.fpenta.temp)
colnames(rac.fpenta.temp)[1] <- "Abundance"
rac.fpenta <- merge(rac.fpenta.temp, data.frame(tax_table(phy97.f.c.fpenta)), by="otu")
rac.fpenta <- rac.fpenta[order(-rac.fpenta$Abundance),]

barplot(rac.fpenta$Abundance[1:N], las=2, names.arg=rac.fpenta$hit[1:N],space=0,col=rac.fpenta$clade,main="Favites pentagona")
```

# Rank Abundance Curves - before and after (alive/dead corals only)
```{r, include=TRUE, echo=FALSE, cache=TRUE}
par(mar=c(12,5,1,1),xaxs="i",yaxs="i",mfrow=c(1,3))
N=15

# All corals: before
rac.before.temp <- data.frame(sort(taxa_sums(phy97.f.c.coral.AD.before)))
rac.before.temp$otu<-rownames(rac.before.temp)
colnames(rac.before.temp)[1] <- "Abundance"
rac.before <- merge(rac.before.temp, data.frame(tax_table(phy97.f.c.coral.AD.before)), by="otu")
rac.before <- rac.before[order(-rac.before$Abundance),]

barplot(rac.before$Abundance[1:N], las=2, names.arg=rac.before$hit[1:N],space=0,col=rac.before$clade,main="All Corals: before")

# Platygyra: before
rac.before.platy.temp <- data.frame(sort(taxa_sums(phy97.f.c.platy.AD.before)))
rac.before.platy.temp$otu<-rownames(rac.before.platy.temp)
colnames(rac.before.platy.temp)[1] <- "Abundance"
rac.before.platy <- merge(rac.before.platy.temp, data.frame(tax_table(phy97.f.c.platy.AD.before)), by="otu")
rac.before.platy <- rac.before.platy[order(-rac.before.platy$Abundance),]

barplot(rac.before.platy$Abundance[1:N], las=2, names.arg=rac.before.platy$hit[1:N],space=0,col=rac.before.platy$clade,main="Platygyra: before")

# FPenta: before
rac.before.fpenta.temp <- data.frame(sort(taxa_sums(phy97.f.c.fpenta.AD.before)))
rac.before.fpenta.temp$otu<-rownames(rac.before.fpenta.temp)
colnames(rac.before.fpenta.temp)[1] <- "Abundance"
rac.before.fpenta <- merge(rac.before.fpenta.temp, data.frame(tax_table(phy97.f.c.fpenta.AD.before)), by="otu")
rac.before.fpenta <- rac.before.fpenta[order(-rac.before.fpenta$Abundance),]

barplot(rac.before.fpenta$Abundance[1:N], las=2, names.arg=rac.before.fpenta$hit[1:N],space=0,col=rac.before.fpenta$clade,main="Favites pentagona: before")

# All corals: during/after
rac.da.temp <- data.frame(sort(taxa_sums(phy97.f.c.coral.AD.da)))
rac.da.temp$otu<-rownames(rac.da.temp)
colnames(rac.da.temp)[1] <- "Abundance"
rac.da <- merge(rac.da.temp, data.frame(tax_table(phy97.f.c.coral.AD.da)), by="otu")
rac.da <- rac.da[order(-rac.da$Abundance),]

barplot(rac.da$Abundance[1:N], las=2, names.arg=rac.da$hit[1:N],space=0,col=rac.da$clade,main="All Corals: During/After")

# Platygyra: during/after
rac.da.platy.temp <- data.frame(sort(taxa_sums(phy97.f.c.platy.AD.da)))
rac.da.platy.temp$otu<-rownames(rac.da.platy.temp)
colnames(rac.da.platy.temp)[1] <- "Abundance"
rac.da.platy <- merge(rac.da.platy.temp, data.frame(tax_table(phy97.f.c.platy.AD.da)), by="otu")
rac.da.platy <- rac.da.platy[order(-rac.da.platy$Abundance),]

barplot(rac.da.platy$Abundance[1:N], las=2, names.arg=rac.da.platy$hit[1:N],space=0,col=rac.da.platy$clade,main="Platygyra: during/after")

# FPenta: during/after
rac.da.fpenta.temp <- data.frame(sort(taxa_sums(phy97.f.c.fpenta.AD.da)))
rac.da.fpenta.temp$otu<-rownames(rac.da.fpenta.temp)
colnames(rac.da.fpenta.temp)[1] <- "Abundance"
rac.da.fpenta <- merge(rac.da.fpenta.temp, data.frame(tax_table(phy97.f.c.fpenta.AD.da)), by="otu")
rac.da.fpenta <- rac.da.fpenta[order(-rac.da.fpenta$Abundance),]

barplot(rac.da.fpenta$Abundance[1:N], las=2, names.arg=rac.da.fpenta$hit[1:N],space=0,col=rac.da.fpenta$clade,main="Favites pentagona: during/after")

```

```{r, include=TRUE, echo=FALSE, cache=TRUE}
# Save grouped data as RData file
save.image(file = "C:/Users/Dani/Documents/Data_Analysis/KI_Platy/data/otus_97/KI_seqs_f_coral_grouped_OTUSummary.RData")
```

