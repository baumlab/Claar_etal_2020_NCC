---
title: "Platy analysis"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<!-- Import libraries -->
```{r, echo=FALSE}
library(stringr)
library(reshape2)
library(phyloseq)
```

<!-- Load filtered RData object from filter_notsym.R script -->
```{r, echo=FALSE}
load("C:/Users/Dani/Documents/Data_Analysis/KI_Platy/data/otus_97/KI_Platy_f.RData")
phy97.f <- phy.f # Rename phyloseq object for clarity
```


<!-- Characterize sites by disturbance level -->
```{r, echo=FALSE}
VeryHigh <- c(33,40,32,31,27,30,26)
High <- c(25,3,38,24)
HighMed <- c(9,34,35,8,14,6)
LowMed <- c(2,22,1,23)
Low <- c(7,13,12,4,36,5,37)
VeryLow <- c(10,21,11,20,16,15,39,19,18,17)

sample_data(phy97.f)$Site <- factor(sample_data(phy97.f)$Site)
sample_data(phy97.f)$Dist <- sample_data(phy97.f)$Site
sample_data(phy97.f)$Dist<- gsub ("34",as.character("HighMed"), as.character(data.frame(sample_data(phy97.f))$Dist), as.character("HighMed"))
sample_data(phy97.f)$Dist<- gsub ("35",as.character("HighMed"), as.character(data.frame(sample_data(phy97.f))$Dist), as.character("HighMed"))
sample_data(phy97.f)$Dist<- gsub ("14",as.character("HighMed"), as.character(data.frame(sample_data(phy97.f))$Dist), as.character("HighMed"))
sample_data(phy97.f)$Dist<- gsub ("15",as.character("VeryLow"), as.character(data.frame(sample_data(phy97.f))$Dist), as.character("HighMed"))
sample_data(phy97.f)$Dist<- gsub ("19",as.character("VeryLow"), as.character(data.frame(sample_data(phy97.f))$Dist), as.character("HighMed"))
sample_data(phy97.f)$Dist<- gsub ("12",as.character("Low"), as.character(data.frame(sample_data(phy97.f))$Dist), as.character("HighMed"))
sample_data(phy97.f)$Dist<- gsub ("37",as.character("Low"), as.character(data.frame(sample_data(phy97.f))$Dist), as.character("HighMed"))
sample_data(phy97.f)$Dist<- gsub ("27",as.character("VeryHigh"), as.character(data.frame(sample_data(phy97.f))$Dist), as.character("HighMed"))
sample_data(phy97.f)$Dist<- gsub ("30",as.character("VeryHigh"), as.character(data.frame(sample_data(phy97.f))$Dist), as.character("HighMed"))
sample_data(phy97.f)$Dist<- gsub ("32",as.character("VeryHigh"), as.character(data.frame(sample_data(phy97.f))$Dist), as.character("HighMed"))
sample_data(phy97.f)$Dist<- gsub ("26",as.character("VeryHigh"), as.character(data.frame(sample_data(phy97.f))$Dist), as.character("HighMed"))
sample_data(phy97.f)$Dist<- gsub ("31",as.character("VeryHigh"), as.character(data.frame(sample_data(phy97.f))$Dist), as.character("HighMed"))
sample_data(phy97.f)$Dist<- gsub ("40",as.character("VeryHigh"), as.character(data.frame(sample_data(phy97.f))$Dist), as.character("HighMed"))
sample_data(phy97.f)$Dist<- gsub ("33",as.character("VeryHigh"), as.character(data.frame(sample_data(phy97.f))$Dist), as.character("HighMed"))
sample_data(phy97.f)$Dist<- gsub ("38",as.character("VeryHigh"), as.character(data.frame(sample_data(phy97.f))$Dist), as.character("High"))
sample_data(phy97.f)$Dist<- gsub ("25",as.character("VeryHigh"), as.character(data.frame(sample_data(phy97.f))$Dist), as.character("High"))
sample_data(phy97.f)$Dist<- gsub ("24",as.character("VeryHigh"), as.character(data.frame(sample_data(phy97.f))$Dist), as.character("High"))
sample_data(phy97.f)$Dist<- gsub ("3",as.character("VeryHigh"), as.character(data.frame(sample_data(phy97.f))$Dist), as.character("High"))
sample_data(phy97.f)$Dist<- gsub ("5",as.character("Low"), as.character(data.frame(sample_data(phy97.f))$Dist), as.character("HighMed"))
sample_data(phy97.f)$Dist<- gsub ("6",as.character("HighMed"), as.character(data.frame(sample_data(phy97.f))$Dist), as.character("HighMed"))
sample_data(phy97.f)$Dist<- gsub ("9",as.character("HighMed"), as.character(data.frame(sample_data(phy97.f))$Dist), as.character("HighMed"))
sample_data(phy97.f)$Dist<- gsub ("8",as.character("HighMed"), as.character(data.frame(sample_data(phy97.f))$Dist), as.character("HighMed"))
```

<!-- Use merge_taxa to collapse OTUs with equivalent names ("hits") -->
```{r, echo=FALSE}
# Find all entries in the taxa_table that contain DI in "hit"
D1s <- grep("D1", data.frame(tax_table(phy97.f))$hit)
# Merge taxa, collapsing all hits with "D1" into 1 row in the taxa table. Eqtaxa says which taxa to collapse together. Archetype is included or it doesn't work, and refers to which name the new collapsed row will take - however I haven't found out how to modify this without it failing yet.
phy97.f.eqtaxa <- merge_taxa(phy97.f, eqtaxa=D1s, archetype=1)
# Create tt from the taxa table (to use in renaming below)
tt <- data.frame(tax_table(phy97.f.eqtaxa), stringsAsFactors = F)
# Create "isna" which includes the rownames of all taxa where "hit"=NA
isna <- rownames(tt)[is.na(tt$hit)]
# Create info by extracting the row's "hit" string from the original taxa table
info <- data.frame(tax_table(phy97.f), stringsAsFactors = F)[isna, "hit"]
# Rename the NA using the extracted "hit" name from above
tt[isna,"hit"] <- info
# Replace the taxa table in phy97coral.f2.eqtaxa with updated taxa table (tt). Must be converted to matrix first to work.
tax_table(phy97.f.eqtaxa) <- as.matrix(tt)

# See D1 for description/explanation
C3s <- grep("C3_", data.frame(tax_table(phy97.f.eqtaxa))$hit)
phy97.f.eqtaxa <- merge_taxa(phy97.f.eqtaxa, eqtaxa=C3s, archetype=1)
tt <- data.frame(tax_table(phy97.f.eqtaxa), stringsAsFactors = F)
isna <- rownames(tt)[is.na(tt$hit)]
info <- data.frame(tax_table(phy97.f), stringsAsFactors = F)[isna, "hit"]
tt[isna,"hit"] <- info
tax_table(phy97.f.eqtaxa) <- as.matrix(tt)

# See D1 for description/explanation
C15s <- grep("C15_", data.frame(tax_table(phy97.f.eqtaxa))$hit)
phy97.f.eqtaxa <- merge_taxa(phy97.f.eqtaxa, eqtaxa=C15s, archetype=1)
tt <- data.frame(tax_table(phy97.f.eqtaxa), stringsAsFactors = F)
isna <- rownames(tt)[is.na(tt$hit)]
info <- data.frame(tax_table(phy97.f), stringsAsFactors = F)[isna, "hit"]
tt[isna,"hit"] <- info
tax_table(phy97.f.eqtaxa) <- as.matrix(tt)

# See D1 for description/explanation
C31s <- grep("C31_", data.frame(tax_table(phy97.f.eqtaxa))$hit)
phy97.f.eqtaxa <- merge_taxa(phy97.f.eqtaxa, eqtaxa=C31s, archetype=1)
tt <- data.frame(tax_table(phy97.f.eqtaxa), stringsAsFactors = F)
isna <- rownames(tt)[is.na(tt$hit)]
info <- data.frame(tax_table(phy97.f), stringsAsFactors = F)[isna, "hit"]
tt[isna,"hit"] <- info
tax_table(phy97.f.eqtaxa) <- as.matrix(tt)

# See D1 for description/explanation
A121 <- grep("A121_", data.frame(tax_table(phy97.f.eqtaxa))$hit)
phy97.f.eqtaxa <- merge_taxa(phy97.f.eqtaxa, eqtaxa=A121, archetype=1)
tt <- data.frame(tax_table(phy97.f.eqtaxa), stringsAsFactors = F)
isna <- rownames(tt)[is.na(tt$hit)]
info <- data.frame(tax_table(phy97.f), stringsAsFactors = F)[isna, "hit"]
tt[isna,"hit"] <- info
tax_table(phy97.f.eqtaxa) <- as.matrix(tt)

# See D1 for description/explanation
A1 <- grep("A1_", data.frame(tax_table(phy97.f.eqtaxa))$hit)
phy97.f.eqtaxa <- merge_taxa(phy97.f.eqtaxa, eqtaxa=A1, archetype=1)
tt <- data.frame(tax_table(phy97.f.eqtaxa), stringsAsFactors = F)
isna <- rownames(tt)[is.na(tt$hit)]
info <- data.frame(tax_table(phy97.f), stringsAsFactors = F)[isna, "hit"]
tt[isna,"hit"] <- info
tax_table(phy97.f.eqtaxa) <- as.matrix(tt)

# See D1 for description/explanation
C3k <- grep("C3k_", data.frame(tax_table(phy97.f.eqtaxa))$hit)
phy97.f.eqtaxa <- merge_taxa(phy97.f.eqtaxa, eqtaxa=C3k, archetype=1)
tt <- data.frame(tax_table(phy97.f.eqtaxa), stringsAsFactors = F)
isna <- rownames(tt)[is.na(tt$hit)]
info <- data.frame(tax_table(phy97.f), stringsAsFactors = F)[isna, "hit"]
tt[isna,"hit"] <- info
tax_table(phy97.f.eqtaxa) <- as.matrix(tt)


phy97.f.eqtaxa.p <- transform_sample_counts(phy97.f.eqtaxa, function(x) x/sum(x))
```

<!-- Use merge_taxa to collapse OTUs by clade -->
```{r, echo=FALSE}
# Find all entries in the taxa_table that contain DI in "hit"
Ds <- grep("^D", data.frame(tax_table(phy97.f))$hit)
# Merge taxa, collapsing all hits with "D1" into 1 row in the taxa table. Eqtaxa says which taxa to collapse together. Archetype is included or it doesn't work, and refers to which name the new collapsed row will take - however I haven't found out how to modify this without it failing yet.
phy97.f.clade <- merge_taxa(phy97.f, eqtaxa=Ds, archetype=1)
# Create tt from the taxa table (to use in renaming below)
tt <- data.frame(tax_table(phy97.f.clade), stringsAsFactors = F)
# Create "isna" which includes the rownames of all taxa where "hit"=NA
isna <- rownames(tt)[is.na(tt$hit)]
# Create info by extracting the row's "hit" string from the original taxa table
info <- "D"
# Rename the NA using the extracted "hit" name from above
tt[isna,"hit"] <- info
# Replace the taxa table in phy97.f.eqtaxa with updated taxa table (tt). Must be converted to matrix first to work.
tax_table(phy97.f.clade) <- as.matrix(tt)

Cs <- grep("^C", data.frame(tax_table(phy97.f.clade))$hit)
phy97.f.clade <- merge_taxa(phy97.f.clade, eqtaxa=Cs, archetype=1)
tt <- data.frame(tax_table(phy97.f.clade), stringsAsFactors = F)
isna <- rownames(tt)[is.na(tt$hit)]
info <- "C"
tt[isna,"hit"] <- info
tax_table(phy97.f.clade) <- as.matrix(tt)

Gs <- grep("^G", data.frame(tax_table(phy97.f.clade))$hit)
phy97.f.clade <- merge_taxa(phy97.f.clade, eqtaxa=Gs, archetype=1)
tt <- data.frame(tax_table(phy97.f.clade), stringsAsFactors = F)
isna <- rownames(tt)[is.na(tt$hit)]
info <- "G"
tt[isna,"hit"] <- info
tax_table(phy97.f.clade) <- as.matrix(tt)

As <- grep("^A", data.frame(tax_table(phy97.f.clade))$hit)
phy97.f.clade <- merge_taxa(phy97.f.clade, eqtaxa=As, archetype=1)
tt <- data.frame(tax_table(phy97.f.clade), stringsAsFactors = F)
isna <- rownames(tt)[is.na(tt$hit)]
info <- "A"
tt[isna,"hit"] <- info
tax_table(phy97.f.clade) <- as.matrix(tt)

Fs <- grep("^F", data.frame(tax_table(phy97.f.clade))$hit)
phy97.f.clade <- merge_taxa(phy97.f.clade, eqtaxa=Fs, archetype=1)
tt <- data.frame(tax_table(phy97.f.clade), stringsAsFactors = F)
isna <- rownames(tt)[is.na(tt$hit)]
info <- "F"
tt[isna,"hit"] <- info
tax_table(phy97.f.clade) <- as.matrix(tt)

Is <- grep("^I", data.frame(tax_table(phy97.f.clade))$hit)
phy97.f.clade <- merge_taxa(phy97.f.clade, eqtaxa=Is, archetype=1)
tt <- data.frame(tax_table(phy97.f.clade), stringsAsFactors = F)
isna <- rownames(tt)[is.na(tt$hit)]
info <- "I"
tt[isna,"hit"] <- info
tax_table(phy97.f.clade) <- as.matrix(tt)


phy97.f.clade.p <- transform_sample_counts(phy97.f.clade, function(x) x/sum(x))

save(phy97.f.clade,phy97.f.clade.p,phy97.f.eqtaxa,phy97.f.eqtaxa.p,file = "C:/Users/Dani/Documents/Data_Analysis/KI_Platy/data/otus_97/KI_Platy_f_grouped.RData")
```

