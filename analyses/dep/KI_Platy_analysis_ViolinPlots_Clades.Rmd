---
title: "KI_Platy_ViolinPlots_Clades.Rmd"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load necesary libraries
library(phyloseq)
library(ggplot2)

# Load grouped data
load("C:/Users/Dani/Documents/Data_Analysis/KI_Platy/data/otus_97/KI_Platy_f_grouped.RData")

# Specify order of levels in Year
levels(sample_data(phy97.f.c.p)$Year) = c("2014", "2015Jan", "2015May","2015July", "2016March")

# MAKE SUBSETS
# Subset samples to only include coral (and exclude water, sediment)
phy97.f.c.p.C <- subset_samples(phy97.f.c.p,SampleType == "coral")
# Subset samples to only include Platygyra
phy97.f.c.p.platy <- subset_samples(phy97.f.c.p.C,Coral_Species=="Platygyra_sp")
# levels(sample_data(phy97.f.c.p.platy)$Coral_Species) # Check if it worked
# Subset samples to only include Favites pentagona
phy97.f.c.p.fpenta <- subset_samples(phy97.f.c.p.C,Coral_Species=="Favites_pentagona")
# Subset samples that were confirmed "alive" or "dead"
phy97.f.c.p.C.AD <- subset_samples(phy97.f.c.p.C,Status=="alive"|Status=="dead")
# Then subset those to only select corals which had Clade G
phy97.f.c.p.C.AD.G <- subset_taxa(phy97.f.c.p.C.AD,clade=="G")
# Then subset those to only select corals which had Clade C
phy97.f.c.p.C.AD.C <- subset_taxa(phy97.f.c.p.C.AD,clade=="C")

```

```{r, include=TRUE}
# Make abundance plotting function
plot_abundance = function(physeq,title = "",
			     Facet = "hit", Color = "hit"){
  mphyseq = psmelt(physeq)
  mphyseq <- subset(mphyseq, Abundance > 0)
  ggplot(data = mphyseq, mapping = aes_string(x = "SampleType",y = "Abundance",
                                 color = Color, fill = Color)) +
    geom_violin(fill = NA) +
     geom_point(size = 1, alpha = 0.3,
                position = position_jitter(width = 0.3)) +
    facet_wrap(facets = Facet) + scale_y_log10()+
    theme(legend.position="none")
}

# Make abundance plot for all samples
PA.all = plot_abundance(phy97.f.c.p,"")
PA.all
```

Interesting note here: see how many variable abundances there are for some C-types within corals, and how this looks restricted in water and sediment. Not sure what this means yet...
Thoughts - if a coral can have higher diversity within a single sample, you could have a wider range of abundances, as some corals only have a few of a specific type, whereas water/sediment are more homogenized? 

```{r, include=TRUE}
plot_abundance2 = function(physeq,title = "",
			     Facet = "hit", Color = "hit"){
  mphyseq = psmelt(physeq)
  mphyseq <- subset(mphyseq, Abundance > 0)
  ggplot(data = mphyseq, mapping = aes_string(x = "Coral_Species",y = "Abundance",
                                 color = Color, fill = Color)) +
    geom_violin(fill = NA) +
     geom_point(size = 1, alpha = 0.3,
                position = position_jitter(width = 0.3)) +
    facet_wrap(facets = Facet) + scale_y_log10()+
    theme(legend.position="none",
    axis.text.x = element_text(angle=90))
}

# Make abundance plot for all samples
PA.coral = plot_abundance2(phy97.f.c.p.C,"")
PA.coral
```

```{r, include=FALSE}
plot_abundance3 = function(physeq,title = "",
			     Facet = "hit", Color = "hit"){
  mphyseq = psmelt(physeq)
  mphyseq <- subset(mphyseq, Abundance > 0)
  ggplot(data = mphyseq, mapping = aes_string(x = "Year",y = "Abundance",
                                 color = Color, fill = Color)) +
    geom_violin(fill = NA) +
     geom_point(size = 1, alpha = 0.3,
                position = position_jitter(width = 0.3)) +
    facet_wrap(facets = Facet) + scale_y_log10()+
    theme(legend.position="none")
}

PA.platy = plot_abundance3(phy97.f.c.p.platy,"")
PA.platy

PA.fpenta = plot_abundance3(phy97.f.c.p.fpenta,"")
PA.fpenta
```

```{r, include=TRUE}
plot_abundance4 = function(physeq,title = "",
			     Facet = "hit", Color = "hit"){
  mphyseq = psmelt(physeq)
  mphyseq <- subset(mphyseq, Abundance > 0)
  ggplot(data = mphyseq, mapping = aes_string(x = "Status",y = "Abundance",
                                 color = Color, fill = Color)) +
    geom_violin(fill = NA) +
     geom_point(size = 1, alpha = 0.3,
                position = position_jitter(width = 0.3)) +
    facet_wrap(facets = Facet) + scale_y_log10()+
    theme(legend.position="none")
}

PA.AD = plot_abundance4(phy97.f.c.p.C.AD,"")
PA.AD
```