---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(phyloseq)
library(ggplot2)
library(caret)
library(plyr)
library(dplyr)
```

```{r, include=TRUE}
pslog <- transform_sample_counts(phy97.f, function(x) log(1 + x))
# Subset samples that were confirmed "alive" or "dead"
pslog.AD <- subset_samples(pslog,Status=="alive"|Status=="dead")


out.wuf.log <- ordinate(pslog.AD, method = "MDS")
evals <- out.wuf.log$values$Eigenvalues
plot_ordination(pslog, out.wuf.log, color = "Status") +
  labs(col = "Status") +
  coord_fixed(sqrt(evals[2] / evals[1]))

SDF = data.frame(samples=sample_names(x), row.names=sample_names(x))
dataMatrix <- data.frame(age = sample_data(pslog)$age2, otu_table(pslog)) # I am very confused about this. How did they get it to work in the first place? Because merging all the sample data columns with the otu_table doesn't match up
dataMatrix <- psmelt(pslog)
dataMatrix <- dataMatrix[c("Year", "hit","Sample")]
  
trainingCorals <- sample(unique(sample_data(pslog)$SampleID), size = 200)
inTrain <- which(sample_data(pslog)$SampleID %in% trainingCorals)
training <- dataMatrix[inTrain,]
testing <- dataMatrix[-inTrain,]
plsFit <- train(Year ~ ., data = training,
		  method = "pls", preProc = "center")
plsClasses <- predict(plsFit, newdata = testing)
table(plsClasses, testing$age)
```