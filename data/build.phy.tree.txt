#working from KI_Platy
#Originally from Moorea_Sym pipeline

#data/otus_97_bysample/all_rep_set_rep_set.fasta = seqs
#data/tax_table.txt = ISDs
#column 9 is clade ID
#awk '{print $1}' data/tax_table.txt = denovo name
#awk '{print $8}' data/tax_table.txt = clade name

#subset ID lists by clade
awk '$9 ~ /^A/{ print $1; }' data/tax_table.txt > data/A_tree_seq.ids
awk '$9 ~ /^B/{ print $1; }' data/tax_table.txt > data/B_tree_seq.ids
awk '$9 ~ /^C/{ print $1; }' data/tax_table.txt > data/C_tree_seq.ids
awk '$9 ~ /^D/{ print $1; }' data/tax_table.txt > data/D_tree_seq.ids
awk '$9 ~ /^E/{ print $1; }' data/tax_table.txt > data/E_tree_seq.ids
awk '$9 ~ /^F/{ print $1; }' data/tax_table.txt > data/F_tree_seq.ids
awk '$9 ~ /^G/{ print $1; }' data/tax_table.txt > data/G_tree_seq.ids
awk '$9 ~ /^H/{ print $1; }' data/tax_table.txt > data/H_tree_seq.ids
awk '$9 ~ /^I/{ print $1; }' data/tax_table.txt > data/I_tree_seq.ids

#Run MACQIIME
source /macqiime/configs/bash_profile.txt

#filter seqs by id list
filter_fasta.py -f data/otus_97_bysample/all_rep_set_rep_set.fasta -s data/A_tree_seq.ids -o data/A_tree_seqs.fasta
filter_fasta.py -f data/otus_97_bysample/all_rep_set_rep_set.fasta -s data/B_tree_seq.ids -o data/B_tree_seqs.fasta
filter_fasta.py -f data/otus_97_bysample/all_rep_set_rep_set.fasta -s data/C_tree_seq.ids -o data/C_tree_seqs.fasta
filter_fasta.py -f data/otus_97_bysample/all_rep_set_rep_set.fasta -s data/D_tree_seq.ids -o data/D_tree_seqs.fasta
filter_fasta.py -f data/otus_97_bysample/all_rep_set_rep_set.fasta -s data/E_tree_seq.ids -o data/E_tree_seqs.fasta
filter_fasta.py -f data/otus_97_bysample/all_rep_set_rep_set.fasta -s data/F_tree_seq.ids -o data/F_tree_seqs.fasta
filter_fasta.py -f data/otus_97_bysample/all_rep_set_rep_set.fasta -s data/G_tree_seq.ids -o data/G_tree_seqs.fasta
filter_fasta.py -f data/otus_97_bysample/all_rep_set_rep_set.fasta -s data/H_tree_seq.ids -o data/H_tree_seqs.fasta
filter_fasta.py -f data/otus_97_bysample/all_rep_set_rep_set.fasta -s data/I_tree_seq.ids -o data/I_tree_seqs.fasta

#check seq number
grep -c ">" data/A_tree_seqs.fasta
grep -c ">" data/B_tree_seqs.fasta
grep -c ">" data/C_tree_seqs.fasta
grep -c ">" data/D_tree_seqs.fasta

#align fasta files for each clade
align_seqs.py -i data/A_tree_seqs.fasta -m muscle -o data/
align_seqs.py -i data/C_tree_seqs.fasta -m muscle -o data/
align_seqs.py -i data/D_tree_seqs.fasta -m muscle -o data/

#remove extra header info from alignments
sed 's/ .*//' data/A_tree_seqs_aligned.fasta > data/A_tree_seqs_aligned_clean.fasta
sed 's/ .*//' data/C_tree_seqs_aligned.fasta > data/C_tree_seqs_aligned_clean.fasta
sed 's/ .*//' data/D_tree_seqs_aligned.fasta > data/D_tree_seqs_aligned_clean.fasta







#convert otu table to biom format
https://www.bioconductor.org/packages/release/bioc/html/biomformat.html

# in R
write.delim(data.frame(otu_table(phy.f)), "otu_table.tsv", quote = FALSE, row.names = T, sep = "\t")

#in QIIME
biom convert -i data/otu_table.tsv -o data/otu_table.biom --to-hdf5 --table-type="OTU table"

#in bash
nano data/otu_table.tsv 
#add OTU tab

beta_diversity.py -i data/otu_table.biom -t data/uber.tre -m weighted_unifrac -o data/ 
